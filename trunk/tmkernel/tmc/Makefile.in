# Tm - an interface code generator.
# Author: C. van Reeuwijk.
#
# All rights reserved.
#
# To customize this Makefile, run configure.
#
# Compilation for Atari ST with Pure C is done with a separate project
# file 'tmc.prj'.
# Compilation for MSDOS/MS-Windows with Borland C is done with a
# makefile. See the file 'README' for details.
 
CC = @CC@
LINKER = @CC@
INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@
LOCALBIN = @prefix@/bin
LOCALLIB = @prefix@/lib
LOCALINCLUDE = @prefix@/include
LOCALMAN = @prefix@/man

# System dependent flags for compilation with debugging
DBUGFLAGS = -g -DLOGNEW -DSTAT

LDFLAGS	= $(DBUGFLAGS)

# C compilation flags
CFLAGS = @CFLAGS@ $(DBUGFLAGS) -I$(LOCALINCLUDE)

# Some names of programs
TM  = tm
LINKER = @CC@

TMCLIB = $(LOCALLIB)/libtmc.a

LIBS = @LIBS@ $(TMCLIB)

MAKEFILE = Makefile

DOC = README

JUNK = tmp core makelog testerr testout alutest llutest config.log \
       aldtest gmon.out log alutest.c aldtest.c llutest.c dist.lst distlist

TESTFILES = \
    cltest.ds test.ds xxtest.c \
    aldokerr aldokout aldtesti aldspec.t aldcode.ct aldcode.ht \
    tmcokerr tmcokout tmctesti tmcspec.t tmccode.ct tmccode.ht \
    aluokerr aluokout alutesti aluspec.t alucode.ct alucode.ht \
    lluokerr lluokout llutesti lluspec.t llucode.ct llucode.ht

FOREIGNFILES = aldtos.prj alutos.prj llutos.prj makefile.tc config.htc \
         	makefile.tos config.hts

# Files for configuration
CONFIGUREFILES = configure config.hin Makefile.in configure.in

DISTFILES = $(TMMODULES) $(TESTFILES) $(DOC) $(FOREIGNFILES) \
	    $(CONFIGUREFILES)

TMMODULES     = tmc.ct tmc.ht \
		calu.ct calu.ht \
                cllu.ct cllu.ht \
                cald.ct cald.ht need.t \
		macros.t tmcid.t aluid.t aldid.t lluid.t

LLUTMSRCS     = llucode.c 

LLUTMHDRS     = llucode.h

TMCTMHDRS      = tmccode.h

TMCTMSRCS      = tmccode.c

ALUTMHDRS      = alucode.h

ALUTMSRCS      = alucode.c

ALDTMHDRS      = aldcode.h

ALDTMSRCS      = aldcode.c


LLUTESTSRCS   = llutest.c llucode.c
LLUTESTHDRS   = llucode.h
LLUTESTOBJS   = llutest.o llucode.o

TMCTESTSRCS   = tmctest.c tmccode.c
TMCTESTHDRS   = tmccode.h
TMCTESTOBJS   = tmctest.o tmccode.o

ALUTESTSRCS   = alutest.c alucode.c
ALUTESTHDRS   = alucode.h
ALUTESTOBJS   = alutest.o alucode.o

ALDTESTSRCS   = aldtest.c aldcode.c
ALDTESTHDRS   = aldcode.h
ALDTESTOBJS   = aldtest.o aldcode.o

OBJS = tmccode.o alutest.o alucode.o alutest.o llucode.o llutest.o aldcode.o aldtest.o

# These sources are generated from tm templates.
TMOUT = tmccode.c tmccode.h alucode.c alucode.h llucode.c llucode.h aldcode.c aldcode.h

help :
	@echo " Possible make targets:"
	@echo "all		Create local running programs."
	@echo "clean		Free disk space."
	@echo "empty		Free disk space."
	@echo "distfiles	List distribution files."
	@echo "install		Install relevant files."
	@echo "test		Run tests."

#
all: tmctest llutest alutest aldtest

# Add rules for the programs themselves here.

test: tmctestrun llutestrun alutestrun aldtestrun

tmctest: $(TMCTESTOBJS)
	$(LINKER) $(LDFLAGS) $(TMCTESTOBJS) $(LIBS) -o tmctest

tmctestrun: tmctest tmctesti tmcokout tmcokerr
	tmctest
	diff testout tmcokout
	diff testerr tmcokerr

tmcinstall: need.t tmc.ct tmc.ht tmcid.t
	-$(INSTALL) -d $(LOCALLIB)
	cat macros.t tmcid.t need.t tmc.ct > tmp4242
	$(INSTALL_DATA) tmp4242 $(LOCALLIB)/tmc.ct
	cat macros.t tmcid.t need.t tmc.ht > tmp4242
	$(INSTALL_DATA) tmp4242 $(LOCALLIB)/tmc.ht
	rm -f tmp4242

alutest: $(ALUTESTOBJS)
	$(LINKER) $(LDFLAGS) $(ALUTESTOBJS) $(LIBS) -o alutest

alutestrun: alutest alutesti aluokout aluokerr
	alutest
	diff testout aluokout
	diff testerr aluokerr

aluinstall: need.t calu.ct calu.ht aluid.t
	-$(INSTALL) -d $(LOCALLIB)
	cat macros.t aluid.t need.t calu.ct > tmp4242
	$(INSTALL_DATA) tmp4242 $(LOCALLIB)/calu.ct
	cat macros.t aluid.t need.t calu.ht > tmp4242
	$(INSTALL_DATA) tmp4242 $(LOCALLIB)/calu.ht
	rm -f tmp4242

aldtest: $(ALDTESTOBJS)
	$(LINKER) $(LDFLAGS) $(ALDTESTOBJS) $(LIBS) -o aldtest

aldtestrun: aldtest aldtesti aldokout aldokerr
	aldtest
	diff testout aldokout
	diff testerr aldokerr

aldinstall: need.t cald.ct cald.ht aldid.t
	-$(INSTALL) -d $(LOCALLIB)
	cat macros.t aldid.t need.t cald.ct > tmp4242
	$(INSTALL_DATA) tmp4242 $(LOCALLIB)/cald.ct
	cat macros.t aldid.t need.t cald.ht > tmp4242
	$(INSTALL_DATA) tmp4242 $(LOCALLIB)/cald.ht
	rm -f tmp4242

llutest:     $(LLUTESTOBJS)
	$(LINKER) $(LDFLAGS) $(LLUTESTOBJS) $(LIBS) -o llutest

llutestrun: llutest llutesti
	llutest
	diff testout lluokout
	diff testerr lluokerr

lluinstall: need.t cllu.ct cllu.ht lluid.t
	-$(INSTALL) -d $(LOCALLIB)
	cat macros.t lluid.t need.t cllu.ct > tmp4242
	$(INSTALL_DATA) tmp4242 $(LOCALLIB)/cllu.ct
	cat macros.t lluid.t need.t cllu.ht > tmp4242
	$(INSTALL_DATA) tmp4242 $(LOCALLIB)/cllu.ht
	rm -f tmp4242

install: tmcinstall lluinstall aluinstall aldinstall

clean:
	rm -f $(JUNK) $(OBJS) $(TMOUT)

distclean:
	rm -f $(JUNK) $(OBJS) $(TMOUT) config.cache config.status config.h

empty:
	rm -f $(JUNK) $(OBJS) $(TMOUT) config.cache config.status config.h

distfiles:
	@echo $(DISTFILES) | tr ' ' '\012'

distlist: $(DISTFILES)
	echo $(DISTFILES) | tr ' ' '\012' > dist.lst

depend: $(TMCTMHDRS) $(TMCTMSRCS) $(LLUTMSRCS) $(LLUTMHDRS) $(ALUTMHDRS) $(ALUTMSRCS) $(ALDTMHDRS) $(ALDTMSRCS)
	mkmf -I$(LOCALINCLUDE) -f $(MAKEFILE)

tmccode.c: tmccode.ct tmc.ct tmcspec.t cltest.ds need.t macros.t tmcid.t
	$(TM) cltest.ds tmccode.ct > tmccode.c

tmccode.h: tmccode.ht tmc.ht tmcspec.t cltest.ds need.t macros.t tmcid.t
	$(TM) cltest.ds tmccode.ht > tmccode.h

alucode.c: alucode.ct calu.ct aluspec.t test.ds need.t macros.t aluid.t
	$(TM) test.ds alucode.ct > alucode.c

alucode.h: alucode.ht calu.ht aluspec.t test.ds need.t macros.t aluid.t
	$(TM) test.ds alucode.ht > alucode.h

aldcode.c : aldcode.ct cald.ct aldspec.t test.ds need.t macros.t aldid.t
	$(TM) test.ds aldcode.ct > aldcode.c

aldcode.h : aldcode.ht cald.ht aldspec.t test.ds need.t macros.t aldid.t
	$(TM) test.ds aldcode.ht > aldcode.h

llucode.c : llucode.ct cllu.ct lluspec.t test.ds need.t macros.t lluid.t
	$(TM) test.ds llucode.ct > llucode.c

llucode.h : llucode.ht cllu.ht lluspec.t test.ds need.t macros.t lluid.t
	$(TM) test.ds llucode.ht > llucode.h

tmctest.c: xxtest.c
	sed -e 's/XXX/tmc/' xxtest.c > tmctest.c

alutest.c: xxtest.c
	sed -e 's/XXX/alu/' xxtest.c > alutest.c

aldtest.c: xxtest.c
	sed -e 's/XXX/ald/' xxtest.c > aldtest.c

llutest.c: xxtest.c
	sed -e 's/XXX/llu/' xxtest.c > llutest.c

###
tmccode.o: tmccode.h config.h
tmctest.o: tmccode.h config.h
alucode.o: alucode.h config.h
alutest.o: alucode.h config.h
aldcode.o: aldcode.h config.h
aldtest.o: aldcode.h config.h
llucode.o: llucode.h config.h
llutest.o: llucode.h config.h
