# Tm - an interface code generator.
# Author: C. van Reeuwijk.
#
# All rights reserved.
#
# To configure this Makefile, run 'configure'
#
# Compilation for Atari ST and MSDOS/MS-Windows is done with a
# separately. See the file 'README' for details.

VERSION=36

MAKEFILE = Makefile
DEPENDFILE = $(MAKEFILE).d
CC = @CC@
LINKER = @CC@
LOCALBIN = @prefix@/bin
LOCALLIB = @prefix@/lib
LOCALINCLUDE = @prefix@/include
LOCALMAN = @prefix@/man
LIBS = @LIBS@ $(LOCALLIB)/libtmc.a
INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@

# -I flags for  .h files
IPATH = -I$(LOCALINCLUDE)
PROG = tm

CFLAGS        = @CFLAGS@ $(IPATH) -DCACHESZ=0 -DVERSION=$(VERSION)
LDFLAGS	      = $(CFLAGS)

TM            = tm

DOC	      = README tm.1

DSFILES       = tm.ds

TMFILES       = tmcode.ct tmcode.ht tmspec.t

TESTFILES     = sub.ds test.ds testin goodout gooderr goodrdir testsub

HDRS	      = refex.h \
		tmdefs.h \
		flag.h \
		error.h \
		tmexpr.h \
		fn.h \
		global.h \
		dsparser.h \
		lex.h \
		tmpath.h \
		misc.h \
		tmstring.h \
		tmtrans.h \
		var.h \
		srchfile.h \
		checkds.h

MAKEFILE      = Makefile

# Source files that are not generated by any tool
NORMALSRCS = \
		checkds.c \
		refex.c \
		tm.c \
		flag.c \
		error.c \
		tmexpr.c \
		fn.c \
		global.c \
		dsparser.c \
		lex.c \
		misc.c \
		tmstring.c \
		tmtrans.c \
		var.c \
		srchfile.c

GENSRCS = tmcode.c tmpath.c

DEPENDSRC = $(NORMALSRCS) $(GENSRCS)

# The more obvious 'OBJS = $(SRCS:.c=.o)' causes a core dump
# in make (!) on HPUX 9.0. It's a jungle out there.
NORMALOBJS = $(NORMALSRCS:.c=.o)
GENOBJS = $(GENSRCS:.c=.o)
OBJS = $(GENOBJS) $(NORMALOBJS)

SRCS = $(NORMALSRCS) $(GENSRCS)

TMOUTPUT = tmcode.c tmcode.h

GENFILES = $(TMOUTPUT) tmpath.c


JUNK          = sedlint y.output lint testerr testout index.sed \
		dsneed.t makelog testscr tm.1c tm.prof log tags dist.lst \
		config.log version.h distlist

FOREIGNFILES = tmtos.prj makefile.tc config.htc makefile.tos config.hts

# Files for configuration
CONFIGUREFILES = configure config.hin Makefile.in configure.in

# Note: TMOUTPUT must be placed after DSFILES and TMFILES
#       to ensure that they are more recent than them. Otherwise
#       tm would be needed to make tm...
DISTFILES = $(DSFILES) $(TMFILES) $(NORMALSRCS) $(HDRS) \
    $(TMOUTPUT) $(TESTFILES) $(DOC) $(FOREIGNFILES) $(CONFIGUREFILES)


help :
	@echo " Possible make targets:"
	@echo "all		Create local running programs."
	@echo "test		Run tests."
	@echo "install		Install relevant files."
	@echo "clean		Free disk space."
	@echo "distfiles	List distribution files."
	@echo "depend		Update dependencies in $(MAKEFILE)."
	@echo "doc		Format documentation."
	@echo "man		Format manual pages."

all: $(PROG)

$(PROG): $(OBJS)
	$(LINKER) $(LDFLAGS) $(OBJS) $(LIBS) -o $(PROG)

install: $(PROG)
	-$(INSTALL) -d $(LOCALBIN)
	$(INSTALL) $(PROG) $(LOCALBIN)/$(PROG)

distclean:
	rm -f $(OBJS) $(JUNK) $(PROG)
	rm -f config.status config.cache config.h

empty:
	rm -f $(OBJS) $(JUNK) $(PROG)
	rm -f config.status config.cache config.h

clean:
	rm -f $(OBJS) $(GENFILES) $(JUNK)

tmcode.h: tmcode.ht tm.ds tmspec.t
	tm tm.ds tmcode.ht > tmcode.h

tmcode.c: tmcode.ct tm.ds tmspec.t
	tm tm.ds tmcode.ct > tmcode.c

tmpath.c: $(MAKEFILE)
	echo 'char libpath[]="$(LOCALLIB)";' > tmpath.c

tags: $(SRCS) $(HDRS)
	ctags $(SRCS) $(HDRS)

man:
	nroff -man tm.1 > tm.1c

version.h: ../version.h
	cp ../version.h version.h

test: testin sub.ds test.ds testsub goodout gooderr $(TM)
	-./tm -dn -v -stest1 -stest2=a -Ibla -o testout -e testerr test.ds testin
	diff testout goodout
	diff testerr gooderr
	diff testrdir goodrdir

realdistfiles: $(DISTFILES)
	touch tmcode.c tmcode.h

distfiles:
	@csh -c 'make realdistfiles >&! makelog'
	@echo $(DISTFILES) | tr ' ' '\012'

distlist: $(DISTFILES)
	touch tmcode.c tmcode.h
	echo $(DISTFILES) | tr ' ' '\012' > dist.lst

gfiles: $(GENSRCS) $(GENHDRS)

depend: gfiles createdepend

createdepend: $(DEPENDFILE)
	$(CC) -MM $(DEPENDSRC) > $(DEPENDFILE)

$(DEPENDFILE):
	touch $(DEPENDFILE)

-include $(DEPENDFILE)
