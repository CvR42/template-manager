\chapter{C support}
\label{s.tmc}
In this chapter a detailed description of the {\C} templates is given.
In appendix \ref{s.calc} an example project is shown that demonstrates
the use of these templates.
\par
The {\C} support consists of two template files: \texttt{tmc.ht} is used
to generate a header file, and \texttt{tmc.ct} is used to generate a code
file. Also, a library is provided that contains service functions
needed by the templates, and the equivalent of the generated routines
for a number of {\C} types.
\par
\index{ANSI C@ANSI {\C}}
The functions are described using ANSI {\C} style type specifications,
and require an ANSI {\C} compiler.
\section{Restrictions}
These templates impose the following restrictions:
\begin{itemize}
\item Tuple types cannot inherit or have inheritors.
\item Only inheritance from a single type is allowed (no multiple inheritance).
\item Virtual types must have at least one inheritor.
\end{itemize}
\section{Type representation}
For all {\Tm} meta-types a representation in {\C} must be chosen.
This is shown in the sections below.
As illustration the type representation of the following types
will be shown:
\verbatiminput{tree.ds}
\subsection{Tuple representation}
For tuple types, the representation of the type is simply a pointer to
a structure containing all the fields of the tuple.
\index{tuple!C template}\index{C template!tuple}
For example:
\begin{showfile}
\begin{verbatim}
typedef str_tree *tree;

struct str_tree {
    int v;
    tree_list t;
};
\end{verbatim}
\end{showfile}
\subsection{Class representation}
Class types are pointers to a structure containing
a tag and all the fields of the type.
The tag is used to distinguish between the class and the possible
subclasses. To access the fields of a subclass, the pointer must
be cast to the appropriate subclass type.
\index{constructor!array list template}\index{array list template!constructor}
For example, constructor type \texttt{ctree} is represented as:
\begin{showfile}
\begin{verbatim}
typedef str_ctree *ctree;
typedef str_treeBranch *treeBranch;
typedef str_treeNull *treeNull;

enum en_ctree {
    TAGtreeBranch, TAGtreeNull
};

struct str_ctree {
    tags_ctree tag;
};

struct str_treeBranch {
    tags_ctree tag;
    int v;
    ctree l;
    ctree r;
};

struct str_treeNull {
    tags_ctree tag;
};
\end{verbatim}
\end{showfile}
The possible tags for a type are enumerated in the \texttt{enum} type
\texttt{tags\_<type>}. Note that no tag is generated for \texttt{ctree},
because this type is virtual.
\par
If a C++ compiler is detected (the preprocessor variable \verb'__cplusplus' 
is defined), a slightly different representation is used:
\begin{showfile}
\begin{verbatim}
typedef str_ctree *ctree;
typedef str_treeBranch *treeBranch;
typedef str_treeNull *treeNull;

enum en_ctree {
    TAGtreeBranch, TAGtreeNull
};

class str_ctree {
public:
    tags_ctree tag;
};

class str_treeBranch : str_ctree {
public:
    int v;
    ctree l;
    ctree r;
};

class str_treeNull : str_ctree {
public:
};
\end{verbatim}
\end{showfile}
This representation avoids some of the casts that are needed in the {\C}
version for \verb'rdup_<type>' and \verb'new_<type>'.
\subsection{Constructor and constructor base representation}
Constructor types are represented in a similar way to class types:
they are pointers to a structure containing
a tag and all the fields of the type.
The tag is used to distinguish between the class and the possible
subclasses. To access the fields of a subclass, the pointer must
be cast to the appropriate subclass type.
\index{constructor!array list template}\index{array list template!constructor}
For example, constructor type \texttt{btree} is represented as:
\begin{showfile}
\begin{verbatim}
typedef str_btree *btree;
typedef str_BTree *BTree;
typedef str_BLeaf *BLeaf;

typedef enum en_btree {
    TAGBTree, TAGBLeaf
} tags_btree;

struct str_BTree {
    tags_btree tag;
    btree l;
    btree r;
};

struct str_BLeaf {
    tags_btree tag;
    int v;
};

struct str_btree {
    tags_btree tag;
};
\end{verbatim}
\end{showfile}
The constructor base type is represented by a separate structure containing
a \texttt{tag} field to indicate the actual constructor.
The possible tags for a type are enumerated in the \texttt{enum} type
\texttt{tags\_<type>}.
\par
As for classes, a slightly different representation is used if
the preprocessor variable \verb'__cplusplus' is used:
\begin{showfile}
\begin{verbatim}
typedef str_btree *btree;
typedef str_BTree *BTree;
typedef str_BLeaf *BLeaf;

typedef enum en_btree {
    TAGBTree, TAGBLeaf
} tags_btree;

struct str_btree {
    tags_btree tag;
};

struct str_BTree : str_btree {
    btree l;
    btree r;
};

struct str_BLeaf : str_btree {
    int v;
};
\end{verbatim}
\end{showfile}
\subsection{List representation}
List types are defined as pointers to a list description structure.
\index{list!array list template}\index{array list template!list}
For example:
\begin{showfile}
\begin{verbatim}
typedef struct str_tree_list *tree_list;

struct str_tree_list {
    unsigned int sz;     /* current number of elements */
    unsigned int room;   /* maximum number of elements */
    tree *arr;           /* ptr to array of 'room' elements */
};
\end{verbatim}
\end{showfile}
\begin{sloppypar}
Note that in the {\C} representation \verb+[tree]+ is called
\verb+tree_list+, and \verb+[[tree]]+ is called \verb+tree_list_list+.
The list description structure contains a pointer to an array, the
current length of the list, and the maximum length of the list before
re-allocation is necessary.
\end{sloppypar}
\subsection{Casting macros}
To access subclasses of a class or constructor base, a cast must be used.
For example:
\begin{showfile}
\begin{verbatim}
void clear_leaf( btree tree )
{
    if( tree->tag == TAGBLeaf ){
        /* This is not recommended. */
        ((BLeaf) tree)->v = 0;
    }
}
\end{verbatim}
\end{showfile}
It is not recommended to access elements this way. Instead, one should
use the \verb'to_<type>()' and \verb'to_const_<type>()' macros that are provided for that purpose:
\begin{showfile}
\begin{verbatim}
void clear_leaf( btree tree )
{
    if( tree->tag == TAGBLeaf ){
        to_BLeaf( tree )->v = 0;
    }
}
\end{verbatim}
\end{showfile}
These macros have as advantage that they can also be used in older
Tm templates (the latest version of these templates provide them),
that future templates are likely to use them, and that the casting
macro can contain a check on the appropriateness of the cast
(not yet implemented).
\par
Since in the current template every subclass is an independent type,
it is also possible to have variables of these types. This allows
constructs such as:
\begin{showfile}
\begin{verbatim}
void clear_leaf( btree tree )
{
    if( tree->tag == TAGBLeaf ){
        BLeaf leaf = to_BLeaf( tree );

        leaf->v = 0;
    }
}
\end{verbatim}
\end{showfile}

\subsection{Null pointers}
For each type and type list a suitable \texttt{NIL} pointer is defined.
\index{<type>NIL@\verb+<type>NIL+}
\index{<type>_listNIL@\verb+<type>_listNIL+}
For example:
\begin{showfile}
\begin{verbatim}
#define treeNIL (tree)0
#define btreeNIL (btree)0
#define tree_listNIL (tree_list)0
\end{verbatim}
\end{showfile}
The following functions show how all the type representations
(in this case the types \texttt{tree}, \texttt{btree}, \texttt{ctree} and the list type
\verb+[tree]+)
are used in a program:
Each function returns the sum of the leave or node values in a given
tree.
\begin{showfile}
\begin{verbatim}
/* Return the sum of all the node values in tree 't'. */
int sum_tree( tree t )
{
    unsigned int ix;
    tree_list tl;
    int s;

    s = 0;
    tl = t->t;
    for( ix=0; ix<tl->sz; ix++ ){
       s += sum_tree( tl->arr[ix] );
    }
    return t->v + s;
}
\end{verbatim}
\end{showfile}

\begin{showfile}
\begin{verbatim}
/* Return the sum of all the leave values in ctree 't'. */
int sum_ctree( ctree t )
{
    int s;

    switch( t->tag )
    {
        case TAGtreeBranch:
            s = sum_ctree( to_treeBranch(t)->l ) +
                sum_ctree( to_treeBranch(t)->r ) +
                to_treeBranch(t)->v;
            break;

        case TAGtreeNull:
            s = 0;
            break;

        default:
            tm_badtag( __FILE__, __LINE__, (int) t->tag );
            break;
    }
    return s;
}
\end{verbatim}
\end{showfile}

\begin{showfile}
\begin{verbatim}
/* Return the sum of all the leave values in btree 't'. */
int sum_btree( btree t )
{
    int s;

    switch( t->tag )
    {
        case TAGBTree:
            s = sum_btree( to_BTree(t)->l ) + sum_btree( to_BTree(t)->r );
            break;

        case TAGBLeaf:
            s = to_BLeaf(t)->v;
            break;

        default:
            tm_badtag( __FILE__, __LINE__, (int) t->tag );
            break;
    }
    return s;
}
\end{verbatim}
\end{showfile}
\subsection{Class hierarchy inquery functions}
Since Tm allows chains of inheritance relation of arbitrary length, it
is sometimes useful to determine whether an element belongs to a given
subclass, without having to enumerate all members of the subclass.
For this purpose the \verb'is_<type>()' macros are provided.
\begin{verbatim}
bool is_<type>( <supertype> e );
bool is_<type>_list( <type>_list e );
\end{verbatim}
\begin{desc}
\index{is_<type>@\verb+is_<type>()+}
\index{is_<type>_list@\verb+is_<type>_list()+}
Given an element return \verb'TRUE' if it is a member of type
\verb'<type>' or one of its subclasses, or \verb'FALSE' if it has
the type of another subclass of the root class of \verb'<type>'.
For classes that do not have superclasses, the macro degenerates to
the constant \verb'TRUE'.
\par
For elements that are member of another type tree, the result is
unspecified.
\par
These macros are currently only available in the \verb'tmc' template.
\end{desc}
\section{Dynamic memory allocation}
\label{s.allocation}
\index{allocation}
One of the important features of {\C} is that it has dynamic memory allocation
available through the functions \verb+malloc()+ and \verb+free()+.
These functions are, however, sensitive to two forms of abuse.
First,
blocks that are requested from \verb+malloc()+
may be released with \verb+free()+, but used after that or even passed to
\verb+free()+ for a second time.
This may lead to serious problems that may be hard to find,
since the symptoms are often not related to the cause, differ between machines
and sometimes even differ between runs.
Another form of abuse of \verb+malloc()+ is that requested blocks are
never released.
This is not inherently dangerous,
and is even a sensible practice in small programs.
For large programs, however, it is undesirable,
since a large amount of memory may be consumed in these blocks,
leading to performance degradation or program failure.
\par
Therefore,
in the ideal situation each call to \verb+malloc()+ is balanced with
\emph{exactly} one call to \verb+free()+.
\par
{\Tm} offers two facilities to ensure that the \verb+malloc()+
and \verb+free()+ calls are in balance.
First,
{\Tm} can generate code to count the number of calls to \verb+new_<type>+
and \verb+fre_<type>+.
The code will be generated if you request the generation of the
function \verb'stat_<basename>' or \verb'get_balance_<basename>'.
For each file of generated {\C} code you may request a function
\verb+stat_<basename>+ to print the allocation and freeing statistics of the
functions in that file.
You can call this function at a place where you expect the statistics
to be in balance (usually at the end of the program) to 
print the actual statistics.
To facilitate checking this, the function \verb+get_balance_<basename>()+
can be generated. It returns the current balance state (there are less, more,
or the same number of allocations as deallocations).
This can be used to routinely check the balance at the end of the program,
and issue a warning if necessary.
\par
It is highly recommended to ensure that a program always terminates
with balanced allocation statistics.
\par
\begin{sloppypar}
For the types \verb'tmstring' and \verb'tmtext' in the \verb'tmc' library
the functions \verb+stat_tmstring()+, \verb+get_balance_tmstring()+,
and \verb+stat_tmtext()+ and \verb+get_balance_tmtext()+ are already provided.
\end{sloppypar}
\par
If the statistics reveal that more blocks have been freed than have
been allocated, there is a serious problem in the software that deserves
immediate attention.
If the statistics reveal that less blocks have been freed than have been
allocated,
the program will function properly, but you should repair this
eventually, since it may conceal an imbalance in the opposite direction.
\par
To find which blocks are never freed,
{\Tm} provides another facility:
if the code is compiled with the {\C} preprocessor variable
\texttt{LOGNEW} defined,
the source file and line of all {\Tm} block allocations are recorded in a
special list.
The entries for all blocks that are freed are removed from the list,
so that the list always contains a description of the currently allocated
blocks.
A report on this list can be written to a file with the function
\verb+report_lognew()+.
Usually the cause of the imbalance is easily determined from this information.
\par
The \texttt{LOGNEW} facility is a powerful debugging aid, but it has an important
disadvantage:
\emph{all} code must be compiled with this option.
\par
To find the place where a second \verb+fre_<type>+ of a block is done is
more difficult;
general \verb+malloc()+ debugging packages may be useful for this.
\section{Creation and destruction}
It is necessary to create and destroy instances of {\Tm} types explicitly.
The functions in this section handle this.
All dynamic memory allocation in {\Tm} templates and routines is done through
the functions \verb+tm_malloc()+ and \verb+tm_realloc()+.
\par
Dynamic memory allocation is very sensitive to errors,
and therefore {\Tm} provides extensive support to detect and repair such
bugs, see section~\ref{s.allocation}.
\par
\begin{verbatim}
<type>_list new_<type>_list();
\end{verbatim}
\begin{desc}
\index{new_<type>_list@\verb+new_<type>_list()+}
Create a new, empty, list.
No array is allocated to store the elements,
since this is not necessary when there are no elements.
When necessary an array will be allocated through \verb+setroom_<type>_list()+.
\end{desc}
\begin{verbatim}
<type> new_<type>( <elmtype> f1, .. <elmtype> fn );
\end{verbatim}
\begin{desc}
\index{new_<type>@\verb+new_<type>()+}
Create a constructor, class or tuple,
and set the elements to the value of the given parameters.
For constructor and class types, the \texttt{tag} field is set to the appropriate
value.
\par
If the type is a subclass, the fields of the superclasses must also
be given, in the order described for the {\Tm} template function \texttt{fields}.
\par
For example, if \texttt{expr} is defined as:
\begin{showfile}
\begin{verbatim}
expr = { line:int } + exprPlus: { a:expr, b:expr } | exprConst: { n:int };
\end{verbatim}
\end{showfile}
The following functions can be generated:
\begin{showfile}
\begin{verbatim}
exprPlus new_exprPlus( int line, expr a, expr b );
exprConst new_exprConst( int line, int n );
\end{verbatim}
\end{showfile}
\end{desc}
\begin{verbatim}
<type>_list setroom_<type>_list( <type>_list l, unsigned int rm );
\end{verbatim}
\begin{desc}
\index{setroom_<type>_list@\verb+setroom_<type>_list()+}
Specify that list \texttt{l} must have room for at least \texttt{rm} elements.
In the templates that use an array to represent the list,
this function will ensure that the array has sufficient room to
store \texttt{rm} elements;
in the linked list template this function is a dummy.
The room in a list is never reduced.
\par
Functions that add elements to a list (such as \verb+append_<type>_list()+,
\verb+concat_<type>_list()+ and
\verb+insert_<type>_list()+) use this function implicitly, the
user only needs these functions for efficiency reasons
(to prevent repeated enlargement of the array)
or to build new list functions.
\end{desc}
\begin{verbatim}
void fre_<type>( <type> e );
void fre_<type>_list( <type>_list l );
\end{verbatim}
\begin{desc}
\index{fre_<type>@\verb+fre_<type>()+}
\index{fre_<type>_list@\verb+fre_<type>_list()+}
Destroy an instance of \texttt{<type>} or \texttt{<type>\_list}.
\end{desc}
\begin{verbatim}
void rfre_<type>( <type> e );
void rfre_<type>_list( <type>_list e );
\end{verbatim}
\begin{desc}
\index{rfre_<type>@\verb+rfre_<type>()+}
\index{rfre_<type>_list@\verb+rfre_<type>_list()+}
Recursively destroy all elements of \texttt{e} and \texttt{e} itself.
\end{desc}
\begin{verbatim}
void stat_<basename>( FILE *f );
\end{verbatim}
\begin{desc}
\index{stat_<basename>@\verb+stat_<basename>()+}
Write statistics of allocation and freeing for each type and type list
associated with \texttt{<basename>} to file \texttt{f}. The code that counts
allocations and deallocations is only generated if \verb'stat_<basename>'
or \verb'get_balance_<basename>' is requested.
\end{desc}
\begin{verbatim}
int get_balance_<basename>( void );
\end{verbatim}
\begin{desc}
\index{get_balance_<basename>@\verb+get_balance_<basename>()+}
\begin{sloppypar}
Return \verb+-1+ if any of the types managed in \verb"<basename>"
has been freed more often than allocated.  Return \verb+1+ if any of
the types managed in \verb"<basename>" has been freed less often than
allocated. Return \verb+0+ if the allocation and freeing are in balance.
The code that counts allocations and deallocations is only generated if
\verb'stat_<basename>' or \verb'get_balance_<basename>' is requested.
\end{sloppypar}
\end{desc}
\subsection{List manipulation}
\begin{verbatim}
<type>_list append_<type>_list( <type>_list l, <type> e );
\end{verbatim}
\begin{desc}
\index{append_<type>_list@\verb+append_<type>_list()+}
Given a list \texttt{l} and an element \texttt{e},
put element \texttt{e} after the elements of \texttt{l}.
Enlarge the array if necessary.
Element \texttt{e} is now `owned' by list \texttt{l}.
\end{desc}
\begin{verbatim}
<type>_list concat_<type>_list( <type>_list la, <type>_list lb );
\end{verbatim}
\begin{desc}
\index{concat_<type>_list@\verb+concat_<type>_list()+}
Given two lists \texttt{la} and \texttt{lb},
append the elements of \texttt{lb} after the elements of \texttt{la}.
Enlarge the array of \texttt{la} if necessary.
The elements of \texttt{lb} are now `owned' by \texttt{la},
and \texttt{lb} itself is destroyed.
\end{desc}
\begin{verbatim}
<type>_list insert_<type>_list( <type>_list l, unsigned p, <type> e );
\end{verbatim}
\begin{desc}
\index{insert_<type>_list@\verb+insert_<type>_list()+}
Insert element \texttt{e} at position \texttt{p} in list \texttt{l}.
All elements at and after position \texttt{p} are moved up in the list
(they have their index in the list incremented).
If \texttt{p} is greater than or equal to the length of \texttt{l},
the element is appended after \texttt{l}.
Element \texttt{e} is now `owned' by list \texttt{l}.
\end{desc}
\begin{verbatim}
<type>_list insertlist_<type>_list(
 <type>_list la,
 unsigned p,
 <type>_list lb
);
\end{verbatim}
\begin{desc}
\index{insertlist_<type>_list@\verb+insertlist_<type>_list()+}
Insert list \texttt{lb} at position \texttt{p} in list \texttt{la}.
All elements at and after position \texttt{p} are moved up in the list
(they have their index in the list incremented).
If \texttt{p} is greater than or equal to the length of \texttt{l},
the elements are appended after \texttt{la}.
All elements in \texttt{lb} are now `owned' by list \texttt{la}, and the
list container of \texttt{lb} is destroyed.
\par
If \texttt{la} is \verb'<type>_listNIL', an error is generated.
If \texttt{lb} is \verb'<type>_listNIL', \texttt{la} is returned unchanged.
\end{desc}
\begin{verbatim}
<type>_list delete_<type>_list( <type>_list l, unsigned int pos );
\end{verbatim}
\begin{desc}
\index{delete_<type>_list@\verb+delete_<type>_list()+}
Delete the element at position \texttt{pos} in list \texttt{l}.
The element is freed using \texttt{rfre\_<type>()}.
All elements after position \texttt{pos} are moved down
(have their index in the list decremented).
If \texttt{pos} is greater than or equal to the length of \texttt{l},
nothing happens.
\end{desc}
\begin{verbatim}
<type>_list deletelist_<type>_list(
 <type>_list l,
 unsigned int from,
 unsigned int to
);
\end{verbatim}
\begin{desc}
\index{deletelist_<type>_list@\verb+deletelist_<type>_list()+}
Delete the element at position \texttt{from} up to, but not including, {\tt
to} in list \texttt{l}.  The elements are freed using \texttt{rfre\_<type>()}.
All elements at position \texttt{to} and up are moved down (have their index
in the list decremented).  If \texttt{from} is greater than or equal to {\tt
to}, or if \texttt{from} is greater than or equal to the length of \texttt{l},
nothing happens.
\end{desc}
\begin{verbatim}
<type>_list extract_<type>_list(
 <type>_list l,
 unsigned int pos,
 <type> *e,
 int *valid
);
\end{verbatim}
\begin{desc}
\index{extract_<type>_list@\verb+extract_<type>_list()+}
Remove the element at position \texttt{pos} from list \texttt{l},
and assign it to \verb'*e'.
All elements after position \texttt{pos} are moved down
(have their index in the list decremented).
If \texttt{pos} is greater than or equal to the length of \texttt{l},
nothing happens.
If there was a valid element at position \texttt{pos}, it is assigned
to \verb'*e', and \verb'*valid' is set to \texttt{1}. Otherwise
\verb'*valid' is set to \texttt{0}, and \verb'*e' is left unchanged.
\par
This function is similar to \verb'delete_<type>_list()', but instead
of deleting an element, it puts it in possession of the caller.
\end{desc}
\begin{verbatim}
<type>_list extractlist_<type>_list(
 <type>_list l,
 unsigned int from,
 unsigned int to,
 <type>_list *e
);
\end{verbatim}
\begin{desc}
\index{extractlist_<type>_list@\verb+extractlist_<type>_list()+}
Remove the elements in the range \texttt{from} up to, but not including \texttt{to} from list \texttt{l},
put them in a new list, and assign this list to \verb'*e'.
All elements after position \texttt{to} are moved down
(have their index in the list decremented) to fill the gap.
If a range extends beyond the size of \texttt{l}, the range is silently
truncated.
\par
This function is similar to \verb'extract_<type>_list()', but it
extracts a range of elements instead of a single one.
\end{desc}
\begin{verbatim}
<type>_list reverse_<type>_list( <type>_list l );
\end{verbatim}
\begin{desc}
\index{reverse_<type>_list@\verb+reverse_<type>_list()+}
Reverse the elements in the given list.
\end{desc}
\section{Recursive duplication}
These functions handle recursive duplication of instances of types and
lists of types.
Duplication means that new instances are created for all elements
in the data-structures.
\begin{verbatim}
<type> rdup_<type>( const_<type> e );
<type>_list rdup_<type>_list( const_<type>_list e );
\end{verbatim}
\begin{desc}
\index{rdup_<type>@\verb+rdup_<type>()+}
\index{rdup_<type>_list@\verb+rdup_<type>_list()+}
Recursively duplicate instance \texttt{e} of type \texttt{<type>} or
\texttt{<type>\_list}.
\end{desc}
\begin{verbatim}
<type>_list slice_<type>_list(
 const_<type>_list e,
 unsigned int b,
 unsigned int e
);
\end{verbatim}
\begin{desc}
\index{slice_<type>_list@\verb+slice_<type>_list()+}
Create a new list that contains recursive duplicates of the elements of
list \texttt{l} with indices \texttt{b} up to but \emph{not} including \texttt{e}.
If \texttt{b>e} or \texttt{b} points beyond the list,
an empty list is returned.
If \texttt{e} points beyond \texttt{l},
it is taken to point to the last element in \texttt{l}.
\end{desc}
\section{Data structure input and output}
These functions handle reading of a textual description of the data structures
and allocation of new instances of the type and list structures for the
read data.
The \texttt{print\_<type>} and \texttt{print\_<type>\_list} functions rely on the
print optimizer in the
{\C} support library to handle the actual printing to a file,
see section~\ref{s.csupportlib}.
\par
\begin{sloppypar}
As an extension to the standard {\Tm} internal representation,
the \verb!print_<type>! and \verb'fprint_<type>' functions print null
pointers as the symbol `\texttt{@}'.
The \verb+fscan_<type>+ functions for the array list code recognizes
this symbol.
\end{sloppypar}
\begin{verbatim}
int fscan_<type>( FILE *f, <type> *p );
int fscan_<type>_list( FILE *f, <type>_list *p );
\end{verbatim}
\begin{desc}
\index{fscan_<type>@\verb+fscan_<type>()+}
\index{fscan_<type>_list@\verb+fscan_<type>_list()+}
Read an instance of data structure \texttt{<type>} or \texttt{<type>\_list}
from file \texttt{f},
allocate new room to hold the data that is read,
and set pointer \texttt{p} to point to the new data.
If no error occurs, a value \texttt{0} is returned.
If an error \emph{does} occur,
a value \texttt{1} is returned, and an error message is put in the array
\texttt{tm\_errmsg} provided by the {\C} support library.
Elements are created all the data that has been read before the error elements,
and they must be freed to keep the allocation statistics in balance.
The \verb+fscan_<type>()+ routines will ensure that in all cases the
data-structures can be destroyed again using \verb+rfre_<type>+.
\end{desc}
\begin{verbatim}
void print_<type>( TMPRINTSTATE *st, const_<type> t );
void print_<type>_list( TMPRINTSTATE *st, const_<type>_list l );
\end{verbatim}
\begin{desc}
\index{print_<type>@\verb+print_<type>()+}
\index{print_<type>_list@\verb+print_<type>_list()+}
Given a print state \texttt{st},
print an instance of data structure \texttt{<type>} or \texttt{<type>\_list}
using the print optimizer, see section~\ref{s.csupportlib}.
\end{desc}
\begin{verbatim}
void fprint_<type>( FILE *f, const_<type> t );
void fprint_<type>_list( FILE *f, const_<type>_list t );
\end{verbatim}
\begin{desc}
\index{fprint_<type>@\verb+fprint_<type>()+}
\index{fprint_<type>_list@\verb+fprint_<type>_list()+}
Print an instance of data structure \texttt{<type>} or \texttt{<type>\_list}
to file \texttt{f}.
\end{desc}
\section{Comparison}
These functions handle recursive comparison of structures.
Given two data structures \texttt{a} and \texttt{b},
an int $\texttt{n}<0$ is returned if $\texttt{a}<\texttt{b}$,
0 if $\texttt{a}=\texttt{b}$,
and an int $\texttt{n}>0$ if $\texttt{a}>\texttt{b}$.
\par
For comparison the following rules are applied:
\begin{itemize}
\item
Tuples are equal if all their elements are equal,
otherwise the first differing element (in the order in which they occur in
the tuple definition) determines the comparison.
\item
Constructors are ordered according to their order of definition in the
data structure file,
where the first defined constructor is the smallest.
Constructors are equal if all their elements are equal,
otherwise the first differing element (in the order in which they occur
in the tuple definition) determines the comparison.
\item
Lists are equal if all their elements are equal,
else the first differing element determines the comparison,
or else the shortest list is the smallest.
\end{itemize}
\par
Resemblance to \texttt{strcmp()} is intentional. In fact it is possible to do:
\begin{showfile}
\begin{verbatim}
#define cmp_tmstring strcmp
\end{verbatim}
\end{showfile}
also note that it is possible to do
\begin{showfile}
\begin{verbatim}
#define cmp_int (a-b)
\end{verbatim}
\end{showfile}
However, it is not wise to do this for \texttt{float} or \texttt{double},
since rounding errors may lead to unexpected behavior.
There are a \texttt{cmp\_float()} and \texttt{cmp\_double()} in the support library,
see section~\ref{s.csupportlib}.
\par
These functions are mainly intended for equality comparison,
and to impose `some' repeatable ordering on the data structures.
The ordering may be different from the desired ordering.
If another comparison function is required for a data type,
the generation of the standard function can be suppressed by
using \texttt{notwantdefs}, see section~\ref{s.config}.
\begin{verbatim}
int cmp_<type>( const_<type> a, const_<type> b );
int cmp_<type>_list( const_<type>_list a, const_<type>_list b );
\end{verbatim}
\begin{desc}
\index{cmp_<type>@\verb+cmp_<type>()+}
\index{cmp_<type>_list@\verb+cmp_<type>_list()+}
Compare data structures \texttt{a} and \texttt{b}, and return a code
according to the table listed previously.
\end{desc}
\section{Equality test}
These functions implement an equality test on structures.
Given two data structures \texttt{a} and \texttt{b},
\texttt{TMTRUE} is returned if all the elements of the structure are equal,
else \texttt{TMFALSE} is returned.
\par
For the equality test the following rules are applied:
\begin{itemize}
\item
Tuples are equal if and only if all their elements are equal.
\item
Constructors are equal if and only if all their elements are equal.
Different constructor types are always differ from eachother.
\item
Lists are equal if and only if they are of the same length, and all their elements are equal.
\end{itemize}
\par
These functions are mainly intended for equality comparison,
but cannot be used to impose an ordering on the data structures.
For this the comparison functions in the previous section can be used.
If another equality test function is required for a data type,
the generation of the standard function can be suppressed by
using \texttt{notwantdefs}, see section~\ref{s.config}.
\begin{verbatim}
tmbool isequal_<type>( const_<type> a, const_<type> b );
tmbool isequal_<type>_list( const_<type>_list a, const_<type>_list b );
\end{verbatim}
\begin{desc}
\index{isequal_<type>@\verb+isequal_<type>()+}
\index{isequal_<type>_list@\verb+isequal_<type>_list()+}
Compare data structures \texttt{a} and \texttt{b}, and return \texttt{TMTRUE}
if and only if all the elements of the structure are equal.
Two constructors can only be equal if they are of the same type.
\end{desc}
\section{The tree walker template}
\label{s.treewalk}
\index{tree walking}
\index{template!tree walking}
In many programs it is necessary to traverse (``walk'') a tree of
datastructures, and so that information can be collected, or checking
or modification can be done. In many cases only a few types of nodes
have to be visited, but nodes of many other types have to be traversed
to reach these nodes. Also, it is very simple to overlook a path to a node
of the given type. For that reason the \verb'tmc' template\footnote{The
tree walker template that is described here is specific for the \texttt{tmc}
template. However, it would be fairly simple to write a similar template
for other standard templates.} is supplemented with a template that
generates code to traverse trees of Tm data structures.

Given a list of types to start from, and a list of types to visit,
the template generates code to traverse the tree of Tm data structures
from the given starting points, and visit all the specified types.
For every instance of the target types the action function of the
type is invoked.

To make the template sufficiently flexible, the user must specify
the signature and invocation of the walker functions. This must be
done by defining a number of macros that generate these parts of
the walker functions. The user must also specify the types to
start from and the types to visit, and provide action functions for
each of the target types.

The use of the tree walker template is demonstrated in appendix \ref{s.calc}.

\subsection{Global structure}
A tree walker template will normally contain the components listed below.
They should be placed in the order shown here:
\begin{enumerate}
\item Definitions for the walker macros.
\item Insertion of the walker template. This will define some
 additional macros.
\item Definition of the list of target types.
\item Generation of forward declarations of the walker functions.
\item Definition of the action functions.
\item Generation of the walker functions.
\item Definition of interface functions to the outside world.
\end{enumerate}
\subsection{Macros supplied by the user}
These macros must be defined before the template itself is included
(see below).
\par
To illustrate the description of the macros, a simple walker is
constructed that returns the number of \texttt{int} fields in a tree.
\begin{verbatim}
.macro generate_walker_signature var t
\end{verbatim}
\begin{desc}
Given the name \verb'var' of the variable that holds the datastructure
we`re walking on, and the type \verb't' of that variable, generate a
signature for the walker function of the given type.
\par
The signature should contain ``\verb'$t $(var)''' somewhere in the list
of parameters. Apart from that, the function can have any signature.
\par
It is recommended to declare the functions as \verb'static', so that
unused functions can be reported. When a walker function is reported
as being unused, this usually means that the
action function does not invoke its walker function, as it should.
\par
For example:
\begin{verbatim}
.macro generate_walker_signature var t
static int count_$t_walker( const $t $(var ) )
.endmacro
\end{verbatim}
\end{desc}
\begin{verbatim}
.macro generate_walker_declaration var t
\end{verbatim}
\begin{desc}
Given the name \verb'var' of the variable that holds the datastructure
we are walking on, and the type \verb't' of that variable, generate a forward
declaration for the walker function of the given type.
\par
The signature should contain ``\verb'$t $(var)''' somewhere in the list
of parameters. Apart from that, the function can have any signature.
\par
This macro is usually identical to \verb'generate_walker_signature',
except that the declaration is ended with a semicolon.
\par
For example:
\begin{verbatim}
.macro generate_walker_declaration var t
static int count_$t_walker( const $t $(var) );
.endmacro
\end{verbatim}
\end{desc}
\begin{verbatim}
.macro generate_descent_call indent var type nowtype
\end{verbatim}
\begin{desc}
Given an indent \verb'indent', a variable \verb'var' to walk into, the
type of the variable \verb'type', and the current type of the variable
\verb'nowtype', generate an invocation to an action or walker.
\par
Assuming that the Tm variable \verb'actors' contains the list of types
that have actions associated with them, it is recommended to define
this macro as follows:
\begin{verbatim}
.macro generate_descent_call indent var type nowtype
.if ${member $(type) $(actors)}
.call generate_action_call "$(indent)" "$(var)" "$(type)" "$(nowtype)"
.else
.call generate_walker_call "$(indent)" "$(var)" "$(type)" "$(nowtype)"
.endif
.endmacro
\end{verbatim}
\begin{sloppypar}
This assumes macros \verb'generate_action_call' and
\verb'generate_walker_call', that have the same parameters as this
macro, and generate a call to an action function and a walker function
respectively. Note that since action functions are expected to invoke
their walker function, they usually have the same signature as the
walker function, so the two macros will look very similar.  In fact,
it is recommended to invoke the walker function from an action function
with a call to the macro \verb'generate_walker_call'.
\end{sloppypar}
\par
For example, assuming we have defined \verb'generate_descent_call' as
shown above, we could define \verb'enerate_action_call' and
\verb'generate_walker_call' as follows:
\begin{verbatim}
.macro generate_action_call indent var type nowtype
.if ${eq $(type) $(nowtype)}
$(indent)n += count_$t_action( $(var) );
.else
$(indent)n += count_$t_action( to_$(type)( $(var) ) );
.endif
.endmacro
..
.macro generate_walker_call indent var type nowtype
.if ${eq $(type) $(nowtype)}
$(indent)n += count_$t_walker( $(var) );
.else
$(indent)n += count_$t_walker( to_$(type)( $(var) ) );
.endif
.endmacro
\end{verbatim}
\end{desc}
\begin{verbatim}
.macro generate_walker_return indent var t
\end{verbatim}
\begin{desc}
Given an indent \verb'indent', the name \verb'var' of the variable that holds
the datastructure we are walking on, and a type \verb't', of that variable,
generate a return statement.
\par
If the tree walker function is defined as a \verb'void' function, the
macro should contain the line
\begin{verbatim}
$(indent)return;
\end{verbatim}
Otherwise a return statement should be generated that returns the
appropriate value.
\par
For example:
\begin{verbatim}
.macro generate_walker_return indent var t
$(indent)return n;
.endmacro
\end{verbatim}
\end{desc}
\begin{verbatim}
.macro generate_walker_locals indent var t
\end{verbatim}
\begin{desc}
Given an indent \verb'ident', the name \verb'var' of the variable
that holds the datastructure we are walking on, and a type \verb't'
of that variable, generate a list of local
declarations for the walker function of that type.
\par
For example:
\begin{verbatim}
.macro generate_walker_locals indent var t
$(indent)int n = 0;
.endmacro
\end{verbatim}
\end{desc}
\begin{verbatim}
.macro generate_empty_walker_body indent var t
\end{verbatim}
\begin{desc}
Given an indent \verb'indent', the name \verb'var' of the variable
that holds the data structure we are walking on, and a type \verb't',
generate a body for an empty function.

Usually, this macro contains code to prevent compiler warnings
about unused variables and parameters.
For example, this macro will usually contain the following line:
\begin{verbatim}
$(indent)(void) $(var);
\end{verbatim}
This will generate a properly indented source code line that casts the
variable holding the data structure to void. Most compilers consider
this a use of the variable.
\par
For example:
\begin{verbatim}
.macro generate_empty_walker_body indent var t
$(indent)(void) $(var);
.endmacro
\end{verbatim}
\end{desc}
\subsection{Invoking the tree walker template}
After the macros describe in the previous section have been defined,
the tree walker template can be invoked. This is done as follows:
\begin{verbatim}
.insert tmcwalk.t
\end{verbatim}
The template will check whether the macros described above have been
defined, and it will define the following macros:
\begin{verbatim}
.macro calc_treewalk starts targets
\end{verbatim}
\begin{desc}
Given the list of types to start from \texttt{starts}, and the list of types
to visit \texttt{targets}, return the list of types that must be visited.
\par
Note that both parameters of this macro could potentially consist of
a list of types. It is therefore recommended that the expressions
for these parameters are surrounded by quotes, so that the list is not
broken up.

\end{desc}
\begin{verbatim}
.macro generate_walker_forwards list
\end{verbatim}
\begin{desc}
Given a list \texttt{list} of types the tree walker should visit, generate
forward declarations for the walker functions for these types. 
\par
To ensure that the list that is passed to the macro is evaluated as
a single parameter, it should be surrounded with quotes.
\end{desc}
\begin{verbatim}
.macro generate_walker list
\end{verbatim}
\begin{desc}
Given a list \texttt{list} of types the tree walker should visit, generate
walker functions for these types.
\par
To ensure that the list that is passed to the macro is evaluated as
a single parameter, it should be surrounded with quotes.
\end{desc}
For example:
\begin{verbatim}
.set actors int
.set startnodes expr
..
.insert tmcwalk.t
..
.set visit_types ${call calc_treewalk "$(startnodes)" "$(actors)"}
\end{verbatim}
\subsection{Generating forward declarations}
\begin{sloppypar}
To generate forward declarations for all walker functions, the
\verb'generate_walker_forwards' macro should be invoked.
Since action functions should invoke their corresponding walker
function, these forward declarations should be placed before the
definition of the action functions.
\end{sloppypar}
\par
For example:
\begin{verbatim}
.call generate_walker_forwards "$(visit_types)"
\end{verbatim}
\subsection{Action functions}
The macro \verb'generate_descent_call' will usually generate a call to
an `action function' for every function that specified as a target type
to \verb'calc_treewalk'. These functions must be supplied by the user.
Usually these functions have the same signature as the tree walker
functions, and invoke the walker function somewhere in their body, so that
sub-trees are also traversed. It is recommended to generate the call
to the walker function with a call to the macro \verb'generate_walker_call'.
\par
For example:
\begin{verbatim}
static int count_int_action( int n )
{
    int n = 1;

.call generate_walker_call "    " n int int
    return n;
}
\end{verbatim}
The walker function for \texttt{int} will be empty, but it is good
practice to call it anyway, if only to prevent a complaint about
unused static functions.
\subsection{Generating of the tree walker}
After the action functions have been defined, the walker functions can
be generated with a call to the macro \verb'generate_walker'.
\par
For example:
\begin{verbatim}
.call generate_walker "$(visit_types)"
\end{verbatim}
\subsection{Interfacing to the outside world}
Walker functions often have additional parameters that represent
the state during the traversal of the tree. It is therefore often
useful to wrap the top-level walker function in an interface function
that creates the initial state before traversal, destroys the state
after traversal, etc. 
\par
The most convenient way to invoke the top-level walker function is to
use a call to the macro \verb'generate_descent_call' with the appropriate
parameters.
\par
For example:
\begin{verbatim}
int count_ints( expr x )
{
    int n = 0;

.call generate_descent_call "    " x expr expr
    return n;
}
\end{verbatim}
\section{The analyzer template}
\label{s.analyzer}
\index{analyzer}
\index{template!analyzer}
Although the tree walker template described in Section~\ref{s.treewalk}
is very useful, there is a particular tree walking task that is better
served by providing a specialized template, namely tree analysis.

It is often necessary to traverse (``walk'') a tree of datastructures, to
collect information about the leaves of the tree, and to combine partial
results with a reduction operation.  Examples of such operations are:
calculating the code size of a statement list, determining wether an
expression is constant, and constructing a list of variables that are
used in an expression. Analysis operations like this are easily generated
by the analyzer template.

In contrast to the tree walker template of Section~\ref{s.treewalk},
actions on leave nodes can usually be generated by the template, although
there is an `escape' to a user-defined function.

\subsection{Global structure}
An analyzer template will normally contain the components listed below.
They should be placed in the order shown here:
\begin{enumerate}
\item Definition of the reduction operation and neutral element.
\item Optionally, definition of a termination test.
\item Definitions for the analyzer macros.
\item Insertion of the analyzer template. This will define some
 additional macros.
\item Definition of the list of target types.
\item Definition of the reduction operations for the target types.
\item Generation of forward declarations of the analyzer functions.
\item Definition of the action functions for `escaped' nodes.
\item Generation of the analyzer functions.
\item Definition of interface functions to the outside world.
\end{enumerate}
\subsection{Variables supplied by the user}
The analyzer template requires that the user defines a number of
variables.
These variables must be defined before the template itself is inserted
(see below).
\par
To illustrate the description of the macros, we construct a simple
analyzer that returns the sum of all \texttt{int} fields in a tree.

\begin{verbatim}
.set reduction_type <type>
\end{verbatim}
\begin{desc}
The type of the reduction value we work on.
\par
For example:
\begin{verbatim}
.set reduction_type int
\end{verbatim}
\end{desc}

\begin{verbatim}
.set neutral_element <value>
\end{verbatim}
\begin{desc}
The value of the neutral element of the reduction operation.
This must be a value of the type that is set for \verb'reduction_type'.
\par
For example:
\begin{verbatim}
.set neutral_element (0)
\end{verbatim}
\end{desc}

\begin{verbatim}
.set analysis_name <name>
\end{verbatim}
\begin{desc}
The name of the analysis to perform. This name is used as prefix for
the tree traversal functions that are generated.
\par
For example:
\begin{verbatim}
.set analysis_name add
\end{verbatim}
\end{desc}

\begin{verbatim}
.set analyze_action_<type> reduction [<value>]
.set analyze_action_<type> function <function_name>
.set analyze_action_<type> constant <value>
.set analyze_action_<type> ignore
\end{verbatim}
\begin{desc}
\begin{sloppypar}
For each target type, there should be a variable of the form
\verb'analyze_action_<type>' to specify the kind of action to perform
for this type.  The supported kinds of action are:
\end{sloppypar}
\begin{itemize}
\item[\texttt{reduction}] A reduction on all fields of the class, constructor
type or tuple, or all elements of the list is done. If an optional
value is given, this value is also incorporated in the reduction.
\item[\texttt{function}] The node is passed to a function that should be
provided by the user. The name of the function to invoke must be provided
as parameter. This function must have a formal parameter list
as generated by the \verb'generate_formal_parameters' macro (see below).
\item[\texttt{constant}] The node has constant value \texttt{value}. Recursion
stops at this node, any fields or list elements are \emph{not} visited.
\item[\texttt{ignore}] The node is ignored. Recursion stops at this node,
any fields or list elements are \emph{not} visited.
\end{itemize}

\par
For example:
\begin{verbatim}
.set analyze_action_exprConst reduction
.set analyze_action_exprPlus reduction 1
.set analyze_action_exprSubtract constant 3
.set analyze_action_foldexpr ignore
.set analyze_action_int function add_int_action
\end{verbatim}
\end{desc}


\subsection{Macros supplied by the user}
The analyzer template requires that the user defines a number of macros.
These macros must be defined before the template itself is included
(see below).
\par
To illustrate the description of the macros, we continue the
construction of a simple analyzer
that returns the sum of all \texttt{int} fields in a tree.
\begin{verbatim}
.macro generate_formal_parameters nm t
\end{verbatim}
\begin{desc}
Given the name of the formal parameter \texttt{nm} and its type \texttt{t},
construct and return the formal parameter list of the analysis functions.

The signature should contain ``\verb'$t $(nm)''' somewhere in the list
of parameters. Apart from that, the function can have any signature.
\par
For example:
\begin{verbatim}
.macro generate_formal_parameters nm t
.return "( $t $(nm) )"
.endmacro
\end{verbatim}
\end{desc}
\begin{verbatim}
.macro generate_actual_parameters nm should_type is_type
\end{verbatim}
\begin{desc}
Given the name \verb'nm' of the variable that holds the datastructure
we are walking on, the type \verb'should_type' of the formal parameter,
and the type \verb'is_type' of the variable \texttt{nm}, construct and
return the the actual parameter list of the analyzer invocation.
\par
For example:
\begin{verbatim}
.macro generate_actual_parameters nm should_type is_type
.if ${eq $(should_type) $(is_type)}
.return "( $(nm) )"
.else
.return "( ($(should_type)) $(nm) )"
.endif
.endmacro
\end{verbatim}
\end{desc}
\begin{verbatim}
.macro generate_reduction_operation a b
\end{verbatim}
\begin{desc}
Given two expressions \texttt{a} and \texttt{b}, construct and return an expression
to evaluate the reduction of these expressions.
\par
For example:
\begin{verbatim}
.macro generate_reduction_operation a b
.return "($a)+($b)"
.endmacro
\end{verbatim}
\end{desc}
\begin{verbatim}
.macro generate_termination_test val
\end{verbatim}
\begin{desc}
Given an expression representing the calculated value thus far, return
an expression that evaluates to true if and only if there is no point
in continuing the evaluation. If this macro is not defined, the analysis
tree walk is never terminated prematurely.
\par
For example, if in the running example we are not interested in the
result if one of the intermediate results is negative, we could define
\verb'generate_termination_test' as follows:
\begin{verbatim}
.macro generate_termination_test val
.return "(($(val))<0)"
.endmacro
\end{verbatim}
The termination test is only intended to speed up analysis; it is not
guaranteed to be used at any point.
\par
The termination test is particularly useful when a boolean reduction
operation is done, since once an intermediate result is \texttt{true} for
a boolean `or' reduction, or \texttt{false} for a boolean `and' reduction,
we know further reduction is useless.
\end{desc}
\begin{verbatim}
.macro generate_empty_walker_body indent var t
\end{verbatim}
\begin{desc}
Given an indent \verb'indent', the name \verb'var' of the variable
that holds the data structure we are walking on, and a type \verb't',
generate a body for an empty function.

Usually, this macro contains code to prevent compiler warnings about
unused variables and parameters.  For example, this macro will usually
contain the following line:
\begin{verbatim}
$(indent)(void) $(var);
\end{verbatim}
This will generate a properly indented source code line that casts the
variable holding the data structure to void. Most compilers consider
this a use of the variable.
\par
For example:
\begin{verbatim}
.macro generate_empty_analyzer_body indent var t
$(indent)(void) $(var);
.endmacro
\end{verbatim}
\end{desc}
\subsection{Invoking the analyzer template}
After the macros describe in the previous section have been defined,
the analyzer template can be invoked. This is done as follows:
\begin{verbatim}
.insert tmcanalyze.t
\end{verbatim}
The template will check whether the variables and macros described above
have been defined, and it will define the following macros:
\begin{verbatim}
.macro calc_analyzer starts targets
\end{verbatim}
\begin{desc}
Given the list of types to start from \texttt{starts}, and the list of types
to visit \texttt{targets}, return the list of types that must be visited.
\par
Note that both parameters of this macro could potentially consist of
a list of types. Therefore expressions for these parameters should be
surrounded by quotes, so that the list is not broken up.
\end{desc}
\begin{verbatim}
.macro generate_analyzer_forwards list
\end{verbatim}
\begin{desc}
Given a list \texttt{list} of types the analyzer should visit, generate
forward declarations for the walker functions for these types.
\par
To ensure that the list that is passed to the macro is evaluated as
a single parameter, it should be surrounded with quotes.
\end{desc}
\begin{verbatim}
.macro generate_analyzer list
\end{verbatim}
\begin{desc}
Given a list \texttt{list} of types the analyzer should visit, generate
walker functions for these types.
\par
To ensure that the list that is passed to the macro is evaluated as a
single parameter, it should be surrounded with quotes.
\end{desc}
For example:
\begin{verbatim}
.set 
.set startnodes expr
.set reduction_type int
.set neutral_element (0)
.set analysis_name add
..
.insert tmcanalyze.t
..
.set visit_types ${call calc_analyzer "$(startnodes)" "$(actors)"}
\end{verbatim}
\subsection{Generating forward declarations}
\begin{sloppypar}
To generate forward declarations for all analyzer functions, the
\verb'generate_analyzer_forwards' macro should be invoked.
Since action functions may invoke their corresponding generated analyzer
function, these forward declarations should be placed before the
definition of the action functions.
\end{sloppypar}
\par
For example:
\begin{verbatim}
.call generate_analyzer_forwards "$(visit_types)"
\end{verbatim}
\subsection{Action functions}
For nodes for which a \texttt{function} action is specified, the user
must specify the function that implements the analysis on this node,
and provide an implementation of this function.  The function must have
a formal parameter list that is compatible with the one generated by the
\verb'generate_formal_parameters' macro, and must return the type that
was specified in the variable \verb'reduction_type'.

For example, for an analyzer that calculates the sum of all \texttt{int}
expressions in a tree, we can simply define an action
\begin{verbatim}
.set analyze_action_int function add_int_action
\end{verbatim}
and provide the following function to implement it:
\begin{verbatim}
static int add_int_action( int n )
{
    return n;
}
\end{verbatim}

\subsection{Generating of the analyzer}
After the action functions have been defined, the analyzer functions can
be generated with a call to the macro \verb'generate_analyzer'.
\par
For example:
\begin{verbatim}
.call generate_analyzer "$(visit_types)"
\end{verbatim}
\subsection{Interfacing to the outside world}
Analyzer functions often have additional parameters that represent
the context during the traversal of the tree. It is therefore often
useful to wrap the top-level analyzer function in an interface function
that creates the context before traversal.
\par
The most convenient way to invoke the top-level analyzer function is to
use the variables and macros that already have been defined for the analyzer.
\par
For example:
\begin{verbatim}
int count_ints( expr x )
{
    int n = $(analysis_name)${call generate_formal_parameters x expr expr};
    return n;
}
\end{verbatim}
\section{{\C} support library}
\label{s.csupportlib}
The {\C} support library provides definitions in
the same class as the generated definitions for a number of commonly used
primitive types.
It also provides definitions that are necessary
for various templates (e.g. the \texttt{print} functions).
\par
For the library the following files are provided:

\begin{desctab}
\texttt{libtmc.a} & The library itself. \\
\texttt{tmc.h} & The header file with declarations for the library functions. \\
\end{desctab}
\subsection{Print optimizer functions}
The print optimizer will attempt as much as possible to write a constructor,
tuple or list on one line.
If this is not possible it will write each item of it on a separate line.
\par
\begin{verbatim}
TMPRINSTATE *tm_setprint(
 FILE *f,
 const int i,
 const int w,
 const int tw,
 const unsigned int flags
);
\end{verbatim}
\begin{desc}
\index{tm_setprint@\verb+tm_setprint()+}
Initialize the print optimizer handler.
The output of the \texttt{print\_<type>()} functions will be written to
file \texttt{f} with an indent \texttt{i} for each list, tuple or constructor.
The output has a maximum of \texttt{w} characters on each line of output.
If \texttt{tw} is not equal to zero, it is interpreted as the width of the
tab character, and all indents will be implemented with as many tab
characters as possible.
Usually \verb'tw' should be 8.
\par
The \texttt{flags} can be used to modify the style of the output. At the
moment no style options are implemented, and the parameter should be 0.
\par
The print state descriptor returned by \texttt{tm\_setprint()} stores the
formatting state. It must be passed to all functions that are used to
print the data structures. After all formatting and printing has been
done, the print state must be destroyed with the function \texttt{tm\_endprint()}
described below.
\par
Typically the function is used as follows:
\begin{verbatim}
TMPRINTSTATE *st = tm_setprint( f, 1, LINEWIDTH, TABSIZE, INDENT );
print_Block( st, blk );
int level = tm_endprint( st );
if( level>0 ){
    fprintf( stderr, "Internal botch: bracket level is %d\n", level );
}
\end{verbatim}
\end{desc}
\begin{verbatim}
int tm_endprint( TMPRINTSTATE *st );
\end{verbatim}
\begin{desc}
\index{tm_endprint@\verb+tm_endprint()+}
Destroy the given print state, and return the listing level of
the print state. The listing level is the number of calls to {\tt
tm\_openlist()}, \texttt{tm\_opencons()}, and \texttt{tm\_opentuple()} that
have not been balanced with the corresponding \texttt{tm\_closelist()},
\texttt{tm\_closecons()}, resp.  \texttt{tm\_closetuple()}. Normally the
listing level returned by \texttt{tm\_endprint()} should be zero.
\end{desc}
\begin{verbatim}
void tm_openlist( TMPRINTSTATE *st );
void tm_closelist( TMPRINSTATE *st );
\end{verbatim}
\begin{desc}
\index{tm_openlist@\verb+tm_openlist()+}
\index{tm_closelist@\verb+tm_closelist()+}
Start or stop a list.
\end{desc}
\begin{verbatim}
void tm_opencons( TMPRINTSTATE *st );
void tm_closecons( TMPRINTSTATE *st );
\end{verbatim}
\begin{desc}
\index{tm_opencons@\verb+tm_opencons()+}
\index{tm_closecons@\verb+tm_closecons()+}
Start or stop a constructor. Since classes are represented in the
same way as constructors, these functions are also used for classes.
\end{desc}
\begin{verbatim}
void tm_opentuple( TMPRINTSTATE *st );
void tm_closetuple( TMPRINTSTATE *st );
\end{verbatim}
\begin{desc}
\index{tm_opentuple@\verb+tm_opentuple()+}
\index{tm_closetuple@\verb+tm_closetuple()+}
Start or stop a tuple.
\end{desc}
\begin{verbatim}
void tm_printword( TMPRINTSTATE *st, const char *w );
\end{verbatim}
\begin{desc}
\index{tm_printword@\verb+tm_printword()+}
Add a word \texttt{w} to the current list, tuple, or constructor.
\end{desc}
\subsection{File scan support functions}
These functions are provided to support the \verb'fscan_<type>' template
functions, and similar functions for primitive types.
\par
\begin{verbatim}
int tm_fscanspace( FILE *f );
int tm_lineno;
\end{verbatim}
\begin{desc}
\index{tm_fscanspace@\verb+tm_fscanspace()+}
\index{tm_lineno@\verb+tm_lineno+}
Skip all spaces, tabs, form feeds and comment in the input up to the
next non-white character.
Increment \texttt{tm\_lineno} for each newline character that is encountered.
A comment is started with \texttt{||} and is terminated by a newline.
It is not allowed to have a single \texttt{|}
followed by another character than another \texttt{|} in the input:
this will put an error message in \texttt{tm\_errmsg} and a return value \texttt{1}.
In all other cases \texttt{0} is returned.
\end{desc}
\begin{verbatim}
int tm_fneedc( FILE *f, int c );
\end{verbatim}
\begin{desc}
\index{tm_fneedc@\verb+tm_fneedc()+}
After skipping spaces, tabs, form feeds and comment,
try to read character \texttt{c} from file \texttt{f}.
Return a value \texttt{1} and put an error message in \texttt{tm\_errmsg} if this
is not possible,
else return \texttt{0}.
\end{desc}
\begin{verbatim}
int tm_fscanopenbrac( FILE *f );
int tm_fscanclosebrac( FILE *f, int n );
\end{verbatim}
\begin{desc}
\index{tm_fscanopenbrac@\verb+tm_fscanopenbrac()+}
\index{tm_fscanclosebrac@\verb+tm_fscanclosebrac()+}
\begin{sloppypar}
Handle brackets around constructors.
\verb+tm_fscanopenbrac()+ counts and returns the number
of open brackets (`\texttt{(}') it encounters up to the first character
that is not white space, comment or an open bracket.
\verb+tm_fscanclosebrac()+ tries to read \texttt{n} close brackets (`\texttt{)}').
It will return \texttt{1} and put an error message in \texttt{tm\_errmsg} if this is
not possible.
It will return \texttt{0} if it is successful.
\end{sloppypar}
\end{desc}
\begin{verbatim}
int tm_fscancons( FILE *f, char *buf, int sz );
\end{verbatim}
\begin{desc}
\index{tm_fscancons@\verb+tm_fscancons()+}
Read a constructor name.
\verb+tm_fscancons()+ tries to read a constructor name consisting of up to
$\texttt{sz}-1$ upper- or lower-case characters or digits.
The constructor name will be copied into \texttt{buf},
and terminated by a `\verb+\0+'.
It will return \texttt{1} and put an error message in \texttt{tm\_errmsg}
if the constructor name has length 0 or is longer than $\texttt{sz}-1$,
else it will return \texttt{0}.
\end{desc}
\begin{verbatim}
const char *tm_escapestring( const unsigned int code );
\end{verbatim}
\begin{desc}
Given an unsigned int \verb+code+ representing the ASCII code of a character,
return a pointer to a string representing this character in an
escape sequence (or an ordinary character, if that is possible).
The returned pointer points to a static buffer that is overwritten
upon the next invocation of the function.
\end{desc}
\begin{verbatim}
int tm_fscanescapedchar( FILE *f, int *code );
\end{verbatim}
\begin{desc}
Try to read a (possibly escaped) character from the file \verb'f'. 
It will return \texttt{1} and put an error message in \texttt{tm\_errmsg}
if no escaped character can be read,
else it will return \texttt{0}.
\end{desc}

\subsection{Template functions for primitive types}
\label{s.primtype}
\begin{verbatim}
void fprint_tmbool( FILE *f, const tmbool b );
void fre_tmbool( tmbool b );
int fscan_tmbool( FILE *f, tmbool *b );
void print_tmbool( TMPRINSTATE *st, const tmbool b );
void rfre_tmbool( tmbool b );
#define tmboolNIL <something>
#define TMTRUESTR "True"
#define TMFALSESTR "False"
typedef tmbool <something>
\end{verbatim}
\begin{desc}
\index{tmbool}
Module functions for type `tmbool'.
A \texttt{tmbool} is the boolean representation used by {\Tm}.
It may have the values \texttt{TMTRUE} and \texttt{TMFALSE}.
This name has been chosen instead of the more obvious `bool',
since this type name is often defined at another place.
For example, the \texttt{curses} software and MS-Windows both define \texttt{bool}.
In \texttt{fscan\_tmbool()}, \texttt{fprint\_tmbool()} and \texttt{print\_tmbool()}
use \texttt{TMTRUESTR} and \texttt{TMFALSESTR} as representation strings.
\end{desc}
\begin{verbatim}
typedef signed char tmschar;
int cmp_tmschar( const tmschar a, const tmschar b );
tmbool isequal_tmschar( const tmschar a, const tmschar b );
void fprint_tmschar( FILE *f, const tmschar c );
void fre_tmschar( tmschar c );
int fscan_tmschar( FILE *f, tmschar *cp );
#define tmscharNIL <something>
void print_tmschar( TMPRINSTATE *st, const tmschar c );
tmschar rdup_tmschar( const tmschar c );
void rfre_tmschar( tmschar c );
\end{verbatim}
\begin{desc}
\index{tmschar}
Module functions for type `\texttt{signed char}'.
\end{desc}
\begin{verbatim}
typedef unsigned char tmuchar;
int cmp_tmuchar( const tmuchar a, const tmuchar b );
tmbool isequal_tmuchar( const tmuchar a, const tmuchar b );
void fprint_tmuchar( FILE *f, const tmuchar c );
void fre_tmuchar( tmuchar c );
int fscan_tmuchar( FILE *f, tmuchar *cp );
#define tmucharNIL <something>
void print_tmuchar( TMPRINSTATE *st, const tmuchar c );
tmuchar rdup_tmuchar( const tmuchar c );
void rfre_tmuchar( tmuchar c );
\end{verbatim}
\begin{desc}
\index{tmuchar}
Module functions for type `\texttt{unsigned char}'.
\end{desc}
\begin{verbatim}
int cmp_int( const int a, const int b );
tmbool isequal_int( const int a, const int b );
void fprint_int( FILE *f, const int i );
void fre_int( int i );
int fscan_int( FILE *f, int *i );
#define intNIL <something>
void print_int( TMPRINSTATE *st, const int i );
int rdup_int( int i );
void rfre_int( int i );
\end{verbatim}
\begin{desc}
\index{int}
Module functions for type `\texttt{int}'.
\end{desc}
\begin{verbatim}
typedef unsigned int tmuint;
int cmp_tmuint( const tmuint a, const tmuint b );
tmbool isequal_tmuint( const tmuint a, const tmuint b );
void fprint_tmuint( FILE *f, const tmuint i );
void fre_tmuint( tmuint u );
int fscan_tmuint( FILE *f, tmuint *p );
void print_tmuint( TMPRINSTATE *st, const tmuint i );
tmuint rdup_tmuint( const tmuint u );
void rfre_tmuint( tmuint u );
#define tmuintNIL <something>
\end{verbatim}
\begin{desc}
\index{tmuint}
Module functions for type `\texttt{unsigned int}'.
\end{desc}
\begin{verbatim}
int cmp_long( const long a, const long b );
tmbool isequal_long( const long a, const long b );
void fprint_long( FILE *f, const long i );
void fre_long( long u );
int fscan_long( FILE *f, long *p );
void print_long( TMPRINSTATE *st, const long i );
long rdup_long( const long u );
void rfre_long( long u );
#define longNIL <something>
\end{verbatim}
\begin{desc}
\index{long}
Module functions for type `\texttt{long int}'.
\end{desc}
\begin{verbatim}
typedef unsigned long int tmulong;
int cmp_tmulong( const tmulong a, const tmulong b );
tmbool isequal_tmulong( const tmulong a, const tmulong b );
void fprint_tmulong( FILE *f, const tmulong i );
void fre_tmulong( tmulong u );
int fscan_tmulong( FILE *f, tmulong *p );
void print_tmulong( TMPRINSTATE *st, const tmulong i );
tmulong rdup_tmulong( const tmulong u );
void rfre_tmulong( tmulong u );
#define tmulongNIL <something>
\end{verbatim}
\begin{desc}
\index{tmulong}
Module functions for type `\texttt{unsigned long int}'.
\end{desc}
\begin{verbatim}
typedef short int tmshort;
int cmp_tmshort( const tmshort a, const tmshort b );
tmbool isequal_tmshort( const tmshort a, const tmshort b );
void fprint_tmshort( FILE *f, const tmshort i );
void fre_tmshort( tmshort u );
int fscan_tmshort( FILE *f, tmshort *p );
void print_tmshort( TMPRINSTATE *st, const tmshort i );
tmshort rdup_tmshort( const tmshort u );
void rfre_tmshort( tmshort u );
#define tmshortNIL <something>
\end{verbatim}
\begin{desc}
\index{tmshort}
Module functions for type `\texttt{short int}'.
\end{desc}
\begin{verbatim}
typedef unsigned short int tmushort;
int cmp_tmushort( const tmushort a, const tmushort b );
tmbool isequal_tmushort( const tmushort a, const tmushort b );
void fprint_tmushort( FILE *f, const tmushort i );
void fre_tmushort( tmushort u );
int fscan_tmushort( FILE *f, tmushort *p );
void print_tmushort( TMPRINSTATE *st, const tmushort i );
tmushort rdup_tmushort( const tmushort u );
void rfre_tmushort( tmushort u );
#define tmushortNIL <something>
\end{verbatim}
\begin{desc}
\index{tmushort}
Module functions for type `\texttt{unsigned short int}'.
\end{desc}
\begin{verbatim}
int cmp_double( const double a, const double b );
tmbool isequal_double( const double a, const double b );
#define doubleNIL <something>
void fprint_double( FILE *f, const double d );
void fre_double( double d );
int fscan_double( FILE *f, double *d );
void print_double( TMPRINTSTATE *st, double d );
double rdup_double( const double d );
void rfre_double( double d );
\end{verbatim}
\begin{desc}
\index{double}
Module functions for type `\texttt{double}'.
\end{desc}
\begin{verbatim}
int cmp_float( float a, float b );
tmbool isequal_float( float a, float b );
#define floatNIL <something>
void fprint_float( FILE *f, float d );
void fre_float( float d );
int fscan_float( FILE *f, float *d );
void print_float( TMPRINSTATE *st, const float d );
float rdup_float( const float d );
void rfre_float( float d );
\end{verbatim}
\begin{desc}
\index{float}
Module functions for type `\texttt{float}'.
\end{desc}
\begin{verbatim}
void fprint_tmsymbol( FILE *f, const tmsymbol s );
void fre_tmsymbol( tmsymbol s );
int fscan_tmsymbol( FILE *f,  tmsymbol *s );
void print_tmsymbol( TMPRINTSTATE *st, const tmsymbol s );
tmsymbol rdup_tmsymbol( const tmsymbol s );
void rfre_tmsymbol( tmsymbol s );
#define tmsymbolNIL <something>
\end{verbatim}
\begin{desc}
\index{tmsymbol}
Module functions for type `tmsymbol'.
See section~\ref{s.tmsymbol} for details about type \verb"tmsymbol".
\end{desc}
\begin{verbatim}
typedef char *tmstring;
typedef const char *const_tmstring;

void fprint_tmstring( FILE *f, const tmstring s );
void fre_tmstring( tmstring s );
int fscan_tmstring( FILE *f,  tmstring *s );
tmstring new_tmstring( const char *s );
void print_tmstring( TMPRINTSTATE *st, const tmstring s );
tmstring rdup_tmstring( const tmstring s );
void rfre_tmstring( tmstring s );
void stat_tmstring( FILE *f );
int get_balance_tmstring( void );
#define tmstringNIL <something>
\end{verbatim}
\begin{desc}
\index{tmstring}
Module functions for type `tmstring'.
A `tmstring' is an array of characters terminated by a `\verb+\0+' character.
Note that \texttt{fscan\_tmstring()}, \texttt{rdup\_tmstring()},
and \texttt{new\_tmstring()} allocate memory for the scanned string,
you must use \texttt{fre\_tmstring()} to return that memory.
\texttt{Stat\_tmstring} prints to file \texttt{f} a line specifying the number of
allocated and freed strings.
There is also a function \verb+realloc_tmstring()+ to enlarge the
string array,
see section~\ref{s.malloc}.
\end{desc}
\begin{verbatim}
tmstring create_tmstring( size_t sz );
\end{verbatim}
\begin{desc}
Given a desired string size \verb'sz', return a new, empty, \texttt{tmstring}
containing room for \verb'sz' characters.
\end{desc}
\begin{verbatim}
typedef char *tmword;
typedef const char *const_tmword;

void fprint_tmword( FILE *f, const_tmword s );
void fre_tmword( tmword s );
int fscan_tmword( FILE *f,  tmword *s );
tmword new_tmword( const char *s );
void print_tmword( TMPRINTSTATE *st, const_tmword s );
tmword rdup_tmword( const tmword s );
void rfre_tmword( tmword s );
#define tmwordNIL <something>
\end{verbatim}
\begin{desc}
\index{tmword}
Module functions for type `tmword'.
A `tmword' is the same as a `tmstring', but the scanning and printing
routines are different. \verb'fscan_tmword()' reads a single word
consisting of one or more characters. All characters are accepted,
except whitespace, and the characters `\verb'(),@[]''.
Like other \verb'fscan_<type>' functions, \verb'fscan_tmword()' allows
any number of parenthesis pairs around the word, and skips
whitespace before the word.
Since a \verb'tmword' is represented as a \verb'tmstring',
you must use \verb'fre_tmstring', or the alias \texttt{fre\_tmword()},
to deallocate that memory.
\end{desc}
\begin{verbatim}
typedef struct <something> *tmtext;
typedef const struct <something> *const_tmtext;

void fprint_tmtext( FILE *f, const tmtext s );
int cmp_tmtext( const tmtext ta, const tmtext tb );
tmbool isequal_tmtext( const tmtext ta, const tmtext tb );
void fre_tmtext( tmtext s );
int fscan_tmtext( FILE *f,  tmtext *s );
tmtext new_tmtext( const char *s );
void print_tmtext( TMPRINTSTATE *st, const tmtext s );
tmtext rdup_tmtext( const tmtext s );
void rfre_tmtext( tmtext s );
void stat_tmtext( FILE *f );
int get_balance_tmtext( void );
#define tmtextNIL <something>
\end{verbatim}
\begin{desc}
\index{tmtext}
Module functions for type `tmtext'.
A `tmtext' is a list of characters, similar to the lists that can be
generated for arbitrary types. See section~\ref{s.tmtext} for more details.
\end{desc}
\subsection{Error functions}
\begin{verbatim}
char tm_errmsg[TM_ERRLEN];
\end{verbatim}
\begin{desc}
\index{tm_errmsg@\verb+tm_errmsg+}
\begin{sloppypar}
A buffer for error messages from {\Tm} functions,
in particular the \texttt{fscan\_<type>()} functions.
The value \texttt{TM\_ERRLEN} is defined in the include file \texttt{tmc.h}.
\end{sloppypar}
\end{desc}
\begin{verbatim}
void tm_fatal( char *file, int line, char *s );
\end{verbatim}
\begin{desc}
\index{tm_fatal@\verb+tm_fatal()+}
Fatal error handler for {\Tm} functions:
given the source file name \texttt{file},
the source line \texttt{line} and the error message \texttt{s},
print the error message \verb+s+.
If \verb+line+ is not equal to $0$, and \verb+file+ is not equal
to \verb+""+ (the empty string) the origin (source file and line)
of the error is printed.
After this, stop the program.
\par
All error messages,
except those about bad tags and dynamic memory problems,
are passed through \verb'tm_fatal()'.
The user can supply another error handler by replacing this function.
\end{desc}
\begin{verbatim}
void tm_badtag( char *file, int line, int tag );
\end{verbatim}
\begin{desc}
\index{tm_badtag@\verb+tm_badtag()+}
Fatal error handler for bad tags: print the position
given by source file name \texttt{file} and source line \texttt{line},
and print the tag value as a decimal and hexadecimal value.
After this stop the program.
This message is \emph{not} printed through \verb'tm_fatal()',
since the occurrence of a bad tag is a symptom of a serious organization
problem.
\end{desc}
\begin{verbatim}
void tm_noroom( void );
\end{verbatim}
\begin{desc}
Handler for allocation errors of \verb+tm_malloc()+, \verb+tm_calloc()+
and \verb+tm_realloc()+.
By default it prints `no room' to \verb+stderr+ and does an
\verb+exit(1)+, but it may be replaced by another function
to incorporate panic shutdown
code (to save, for example, the file being edited).
If this function returns (the default one does not), the {\Tm}
allocation routines will try again to allocate the requested block.
This way, garbage collection may be implemented.
\end{desc}
\subsection{\texttt{LOGNEW} functions}
For a detailed explanation of the purpose of \texttt{LOGNEW} functions,
see section~\ref{s.allocation}.
\begin{verbatim}
void tm_lognew(
 const tm_neutralp p,
 const char *file,
 const int line
);
\end{verbatim}
\begin{desc}
\index{tm_lognew@\verb+tm_lognew()+}
Given a pointer \texttt{p}, record it as a new entry in the lognew table.
The current values of \verb+nwl_f+ and \verb+nwl_l+
are stored to record the source-code position of the block request.
\end{desc}
\begin{verbatim}
void tm_logfre( const tm_neutralp p );
\end{verbatim}
\begin{desc}
\index{tm_logfre@\verb+tm_logfre()+}
Given a pointer \texttt{p}, delete its entry from the lognew table.
\end{desc}
\begin{verbatim}
long int tm_new_logid( const char *file, const int line );
\end{verbatim}
\begin{desc}
\index{tm_new_logid@\verb+tm_new_logid()+}
Request a new number to identify a {\Tm} allocation block.
\par
When called, \verb+file+ and \verb+line+
are stored to record the source-code position of the block request.
The {\Tm} code templates store the identification number in the
allocated block.
When the block is freed, the entry is removed from the list
using the identification number, with a call to \verb+tm_fre_logid()+.
This method is more efficient than that of \verb+tm_lognew()+
and \verb+tm_logfre()+,
but requires that the identification number is stored in the
allocated block.
It is therefore unsuitable to log \verb+tmstring+ allocations.
\end{desc}
\begin{verbatim}
void tm_fre_logid( const long int i );
\end{verbatim}
\begin{desc}
\index{tm_fre_logid@\verb+tm_fre_logid()+}
Remove the block with id \texttt{i} from the list of pending blocks.
See the description of \verb+tm_new_logid()+.
\end{desc}
\begin{verbatim}
void report_lognew( FILE *f );
\end{verbatim}
\begin{desc}
\index{report_lognew@\verb+report_lognew()+}
Print the pending entries in the lognew table to file \texttt{f}.
\end{desc}
\begin{verbatim}
void flush_lognew();
\end{verbatim}
\begin{desc}
\index{flush_lognew@\verb+flush_lognew()+}
Clear the table of lognew entries, and free any memory that
has been allocated for it.
\end{desc}
\subsection{Dynamic memory allocation}
\label{s.malloc}
\index{malloc@\verb+malloc()+}
Type handling for \verb+malloc()+ and friends is a \emph{minefield}.
Different compilers have different ideas about neutral pointers, whether the
result of a malloc should be cast, etc.
The functions and defines in the {\Tm} {\C} library try to meet the demands
for the various compilers by introducing a number of 
compiler-dependent definitions.
\par
The allocation functions invoke a function \verb+tm_noroom()+ to print
the actual error message.
A default function is provided that prints the message to \verb+stderr+
and does an \verb+exit(1)+.
To implement emergency handling or even recovery,
the user can provide a different \verb+tm_noroom()+ function.
\par
Dynamic memory allocation is very sensitive to errors.
Therefore,
{\Tm} provides extensive support to detect and repair such bugs,
see section~\ref{s.allocation}.
\begin{verbatim}
typedef <something> tm_neutralp;
\end{verbatim}
\begin{desc}
\index{tm_neutralp@\verb+tm_neutralp+}
The pointer type that is the `neutral' pointer type for this compiler.
\end{desc}
\begin{verbatim}
tm_neutralp tm_malloc( size_t sz );
tm_neutralp tm_calloc( size_t n, size_t sz );
tm_neutralp tm_realloc( tm_neutralp p, size_t sz );
\end{verbatim}
\begin{desc}
\index{tm_malloc@\verb+tm_malloc()+}
\index{tm_calloc@\verb+tm_calloc()+}
\index{tm_realloc@\verb+tm_realloc()+}
The standard \verb+malloc()+ routine and friends,
but with important differences:
\begin{enumerate}
\item They return a pointer of type \verb+tm_neutralp+, which may not
      be the same type as that of the original routine.
\item They handle out of memory situations by invoking \verb+tm_noroom()+.
      If \verb'tm_noroom()' returns, (the default one does not),
      they try again to allocate the requested memory.
\item They are guaranteed to accept \verb'sz = 0' and \verb'n = 0'.
\end{enumerate}
You cannot use these functions directly in portable code, since some
compilers will require casts of the pointer parameters and return values,
while other compilers require that you do \emph{not}.  Therefore, a set
of compiler dependent macros is provided to solve this problem.
\end{desc}
\begin{verbatim}
#define TM_MALLOC(t,sz) <something>
#define TM_CALLOC(t,n,sz) <something>
#define TM_REALLOC(t,p,sz) <something>
#define TM_FREE(p) <something>
\end{verbatim}
\begin{desc}
\index{TM_REALLOC@\verb+TM_REALLOC()+}
\index{TM_CALLOC@\verb+TM_CALLOC()+}
\index{TM_MALLOC@\verb+TM_MALLOC()+}
System-independent versions of the \verb+tm_malloc()+ functions and
friends.
They have the same parameters as the functions, but have an additional
parameter \verb+t+ that indicates the type the returned pointer
should have.
\end{desc}
\begin{verbatim}
tmstring realloc_tmstring( tmstring s, const size_t sz );
\end{verbatim}
\begin{desc}
\index{realloc_tmstring@\verb+realloc_tmstring()+}
Given a tmstring \verb+s+ and a string size \verb+sz+,
invoke \verb+tm_realloc()+ to enlarge \verb+s+ to have at least
\verb+sz+ bytes.
You should not use \verb+tm_realloc()+ on strings directly,
since this confuses the \verb+LOGNEW+ functions.
\end{desc}
\subsection{Text handling}
\label{s.tmtext}
\begin{verbatim}
typedef tmtextptr <something>;

typedef struct str_tmtext {
    tmtextptr arr;
    long curpos;        /* Current read or write pointer. */
    long sz;
    long room;
    long int lognew_id;
} *tmtext;
\end{verbatim}
\par
A \verb'tmtext' is a list of \verb'tmuchar', similar to other
lists, with some additional functionality. The type \verb'tmtextptr' is a
pointer to \verb'tmuchar'.
The main reason this deserves a typedef is that this way it can be declared
\verb'huge', as is required for MS-DOS and some versions of MS-Windows.
Next to the standard support functions (see~\ref{s.primtype}),
a number of additional functions are provided.
\begin{verbatim}
extern void stat_tmtext( FILE *f );
\end{verbatim}
\begin{desc}
\index{stat_tmtext()@\verb'stat_tmtext()'}
This function is equivalent to the standard \verb'stat_<basename>()' function:
given a file handle \verb'f', print the allocation and freeing statistics
to that file.
\end{desc}
\begin{verbatim}
extern int get_balance_tmtext( void );
\end{verbatim}
\begin{desc}
\index{get_balance_tmtext()@\verb'get_balance_tmtext()'}
This function is equivalent to the standard \verb'get_balance_<basename>()'
function: return the current balance state of \verb'tmtext'. 
The function returns $-1$ if more instances have been freed than have
been allocated, $1$ if more instances have been allocated than freed,
and $0$ if the same number of instances have been allocated and freed.
\end{desc}
\begin{verbatim}
extern tmtext setroom_tmtext( tmtext t, long rm );
\end{verbatim}
\begin{desc}
\index{setroom_tmtext()@\verb'setroom_tmtext()'}
This function is similar to the standard \verb'setroom_<type>()'
function.
Specify that text \texttt{t} must have room for at least \texttt{rm} characters.
This function ensures that the array has sufficient room to
store \texttt{rm} elements.
The room in a list is never reduced.
\par
Functions that add elements to a \verb'tmtext' use this function implicitly,
the user only needs these functions for efficiency reasons
(to prevent repeated enlargement of the array)
or to build new list functions.
\end{desc}
\begin{verbatim}
extern tmtext slice_tmtext( const tmtext t, long from, long to );
\end{verbatim}
\begin{desc}
\index{slice_tmtext()@\verb'slice_tmtext()'}
This function is similar to the standard \verb'slice_<type>()'
function.
Given a text \verb't', a start position \verb'from' and an end position
\verb'to', create a new text containing the character from \verb't'
starting from \verb'from' up to (but not including) \verb'to'.
\par
If the specified range extends beyond the real text, the range is
limited to the real text.
\end{desc}
\begin{verbatim}
extern tmtext delblock_tmtext( tmtext t, long from, long to );
\end{verbatim}
\begin{desc}
\index{delblock_tmtext()@\verb'delblock_tmtext()'}
Given a text \verb't', a starting position \verb'from' and an end position
\verb'to', delete the characters from \verb'from' up to, but not including
\verb'to'.
Characters above this range are moved down to close the gap.
If all or part of the specified range to delete falls beyond the text,
that part of the range is ignored.
\end{desc}
\begin{verbatim}
extern tmtext replace_tmtext(
 tmtext t,
 const long from,
 const long to,
 const tmtext nw
);
\end{verbatim}
\begin{desc}
\index{replace_tmtext()@\verb'replace_tmtext()'}
Given a text \verb't', a starting position \verb'from', an ending
position \verb'to', and a text \verb'nw', replace the characters in 
that range with the characters in \verb'nw'. The characters beyond the
range, from \verb'to' upwards, are moved up or down to close the gap.
Return the new text.
\end{desc}
\begin{verbatim}
extern tmtext insert_tmtext( tmtext t, const long pos, const tmtext nw );
\end{verbatim}
\begin{desc}
\index{replace_tmtext()@\verb'replace_tmtext()'}
Given a text \verb't', a position \verb'pos', 
and a text \verb'nw', insert \verb'nw' in \verb't' at position \verb'pos'.
If \verb'pos' is negative, \verb'nw' is inserted at the start of the text,
if \verb'pos' is greater than the size of \verb't', \verb'nw' is appended
at the end of the text.
\par
The new text is returned.
\end{desc}
\begin{verbatim}
extern int cmp_string_tmtext( const char *s, const tmtext t );
\end{verbatim}
\begin{desc}
\index{cmp_string_tmtext()@\verb'cmp_string_tmtext()'}
Given a string \verb's' and a text \verb't', return $-1$ if \verb't' is
smaller than \verb's', return $1$ if \verb't' is greater than \verb's', and
return $0$ if they are equal. 
\end{desc}
\begin{verbatim}
extern tmstring tmtext_to_tmstring( const tmtext t );
\end{verbatim}
\begin{desc}
\index{tmtext_to_tmstring()@\verb'tmtext_to_tmstring()'}
Given a text \verb't', return a \verb'tmstring' that contains these characters.
It is assumed that \verb't' does not contain \verb"'\0'" characters.
\end{desc}
\begin{verbatim}
extern tmtext string_to_tmtext( const char *s );
\end{verbatim}
\begin{desc}
\index{string_to_tmtext()@\verb'string_to_tmtext()'}
Given a string \verb's', return a new text consisting of this string.
\end{desc}
\begin{verbatim}
extern void puts_tmtext( const char *s, tmtext t );
extern void putc_tmtext( tmuchar c, tmtext t );
\end{verbatim}
\begin{desc}
\index{puts_tmtext()@\verb'puts_tmtext()'}
\index{putc_tmtext()@\verb'putc_tmtext()'}
Given a text \verb't' and a character \verb'c' or a string \verb's', write
this string or character to the text at the position \verb't->curpos'.
If necessary the text is enlarged. \verb't->curpos' is incremented
to point past the written characters.
\end{desc}
\subsection{Symbol handling}
\label{s.tmsymbol}
\index{tmsymbol}
These functions maintain a table of strings.
Each time a string is added to the table,
a value of type \texttt{symbol} is returned.
It is guaranteed that for equal strings the same value is returned,
and it is possible to compare these values with a simple compare (\texttt{==}).
There is a special `nil' value, \texttt{symbolNIL}.
\par
To store the information for a symbol, the following data structure is used:
\begin{verbatim}
/* Storage for a symbol string */
struct _tmc_sym {
   struct _tmc_sym *next;       /* next in list */
   tmstring name;               /* pointer to the string */
   tm_neutralp data;            /* any info for it. */
};

typedef struct _tmc_sym *tmsymbol;
typedef const struct _tmc_sym *const_tmsymbol;
\end{verbatim}
The tmstring of this symbol is stored in field \verb+name+.
The name of a tmsymbol \verb+s+ can be printed with
\begin{showfile}
\begin{verbatim}
printf( "%s", s->name );
\end{verbatim}
\end{showfile}
The field \verb+data+ is never touched by the symbol handling routines,
it may be used to store user data associated with the symbol.
\par
Next to the standard template functions, a number of other functions
are defined:
\begin{verbatim}
tmsymbol add_tmsymbol( const char *name );
\end{verbatim}
\begin{desc}
\index{add_tmsymbol@\verb+add_tmsymbol()+}
Add string \texttt{name} to the symbol table.
If the string already occurs in the table, the value of the old
entry is returned, else a new entry is created,
and a new value is returned.
\par
This routine ensures that for all symbols with the same name,
the same value is returned.
\end{desc}
\begin{verbatim}
tmsymbol find_tmsymbol( char *name );
\end{verbatim}
\begin{desc}
\index{find_tmsymbol@\verb+find_tmsymbol()+}
Try to locate string \texttt{name} in the symbol table.
If it occurs in the table, its value is returned,
else \texttt{symbolNIL} is returned.
\end{desc}
\begin{verbatim}
void flush_tmsymbol();
\end{verbatim}
\begin{desc}
\index{flush_tmsymbol@\verb+flush_tmsymbol()+}
Empty the symbol table, and free all memory allocated to it.
It is allowed to start using \verb+add_tmsymbol()+
and \verb+gen_tmsymbol()+ again,
but new symbol values will be returned.
\end{desc}
\begin{verbatim}
tmsymbol gen_tmsymbol( const char *prefix );
\end{verbatim}
\begin{desc}
\index{gen_tmsymbol@\verb+gen_tmsymbol()+}
Given a string \texttt{prefix}, generate a new symbol value with a new string.
It is not allowed to use \verb+add_tmsymbol()+ after you have used
\verb+gen_tmsymbol()+.
Otherwise it cannot be guaranteed that the generated symbols remain unique.
This restriction is enforced by the routines.
\end{desc}
\section{Tm and {\C} configuration variables}
\label{s.config}
The templates use a few {\Tm} variables to modify the contents
of the generated code.
Unless stated otherwise,
it is not necessary to set them;
a reasonable default will be chosen.
\par
\begin{desctab}
\texttt{basename}\index{basename@\texttt{basename}}
&
This variable is used to generate the names of
definitions that are generated only once
(e.g. initialization and statistics functions).
This variable \emph{must} be set.
\\
\texttt{wantdefs}\index{wantdefs@\texttt{wantdefs}}
&
If set,
this variable contains the names of the type and function definitions that
must be generated.
If these functions require the definition of other functions,
the necessary functions will be generated,
but will be declared \texttt{static}.
If \texttt{alldefs} is set all possible definitions are generated.
\\
\texttt{notwantdefs}\index{notwantdefs@\texttt{notwantdefs}}
&
If set, this variable contains the names of the type and function
definitions for which under \emph{all} conditions \emph{no} code must
be generated.
\\
\texttt{alldefs}\index{alldefs@\texttt{alldefs}}
&
If set,
this variable indicates that all possible type and function definitions, and
all functions for first level lists, must be generated for all defined types.
\end{desctab}
\par
At least one of the variables \texttt{wantdefs} and \texttt{alldefs}
must be set.
\par
In the generated {\C} code a number of preprocessor variables are used:
\par
\begin{desctab}
\texttt{FATAL(msg)}\index{FATAL@\texttt{FATAL()}}
&
\texttt{\#define} this if you want to supply a fatal error handler to print
\texttt{msg}.
By default \verb'tm_fatal()' is used,
see section~\ref{s.csupportlib}.
\\
\texttt{FIRSTROOM}\index{FIRSTROOM@\texttt{FIRSTROOM}}
&
The initial room of an array when created with \verb+new_<type>_list()+.
Default it is 0.
\\
\texttt{LOGNEW}\index{LOGNEW@\texttt{LOGNEW}}
&
\texttt{\#define} this if you want code to record the origin of all
\verb+new_<type>()+ requests.
If this code is enabled, you can print with \verb+report_lognew()+ the
source file and line of all pending allocated blocks.
See section~\ref{s.allocation} for a detailed description.
\par
\emph{Important:} \texttt{LOGNEW} only works if all code is compiled
with \texttt{LOGNEW}.
\\
\end{desctab}
