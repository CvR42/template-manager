# A sample Tm project
# Author: C. van Reeuwijk.
#
# All rights reserved.
#
# To configure this Makefile, run 'configure'

MAKEFILE = Makefile
DEPENDFILE = $(MAKEFILE).d
CC = @CC@
LINKER = @CC@
LOCALBIN = @prefix@/bin
LOCALLIB = @prefix@/lib
LOCALINCLUDE = @prefix@/include
LOCALMAN = @prefix@/man
LIBS = @LIBS@ $(LOCALLIB)/libtmc.a
INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@
LEX = @LEX@
YACC = @YACC@

# -I flags for  .h files
IPATH = -I$(LOCALINCLUDE)
PROG = calcparse

CFLAGS        = @CFLAGS@ $(IPATH) -DCACHESZ=0 -DVERSION=$(VERSION) -DSTAT
LDFLAGS	      = $(CFLAGS)

TM            = tm

DOC	      = README

DSFILES       = calc.ds

TMFILES       = calc.ct calc.ht calcconf.t

TESTFILES     = test.calc oktest.clc okopt.clc

HDRS	      =

MAKEFILE      = Makefile

# Source files that are not generated by any tool
NORMALSRC = 

GENSRC = calc.c calclex.c calcparse.c

GENHDR = calc.h tokens.h

DEPENDSRC = $(NORMALSRC) $(GENSRC)

OBJS = $(SRCS:.c=.o)

SRC = $(NORMALSRC) $(GENSRC)

TMOUTPUT = calc.c calc.h

GENFILES = $(GENSRC) $(GENHDR)

PARSESRC = calcparse.y calclex.l

PARSEGEN = calcparse.c calclex.c calc.c

PARSEOBJ = $(PARSEGEN:.c=.o)

OPTSRC = calcopt.c calc.c

OPTOBJ = $(OPTSRC:.c=.o)

JUNK          = sedlint y.output lint testerr testout index.sed \
		dsneed.t makelog testscr  log tags dist.lst \
		config.log version.h distlist $(GENSRC) $(GENHDR) \
		test.clc opt.clc $(OPTOBJ) $(PARSEOBJ)

# Files for configuration
CONFIGUREFILES = configure Makefile.in configure.in

DISTFILES = $(DSFILES) $(TMFILES) $(NORMALSRCS) $(HDRS) calcopt.c \
    $(TESTFILES) $(DOC) $(FOREIGNFILES) $(CONFIGUREFILES) $(PARSESRC)


help :
	@echo " Possible make targets:"
	@echo "all		Create local running programs."
	@echo "test		Run tests."
	@echo "install		Install relevant files."
	@echo "clean		Free disk space."
	@echo "distfiles	List distribution files."
	@echo "depend		Update dependencies in $(MAKEFILE)."
	@echo "doc		Format documentation."
	@echo "man		Format manual pages."

all: calcparse calcopt

calcparse: $(PARSEOBJ)
	$(LINKER) $(LDFLAGS) $(PARSEOBJ) $(LIBS) -o calcparse

calcopt: $(OPTOBJ)
	$(LINKER) $(LDFLAGS) $(OPTOBJ) $(LIBS) -o calcopt

install:
	@echo "Nothing to install"

distclean:
	rm -f $(OBJS) $(JUNK) $(PROG)
	rm -f config.status config.cache config.h

empty:
	rm -f $(OBJS) $(JUNK) $(PROG)
	rm -f config.status config.cache config.h calcparse calcopt

clean:
	rm -f $(OBJS) $(GENFILES) $(JUNK)

calc.h: calc.ht calc.ds calcconf.t
	tm calc.ds calc.ht > calc.h

calc.c: calc.ct calc.ds calcconf.t
	tm calc.ds calc.ct > calc.c

tags: $(SRCS) $(HDRS)
	ctags $(SRCS) $(HDRS)

test.clc: calcparse test.calc
	calcparse < test.calc > test.clc

opt.clc: test.clc
	calcopt < test.clc > opt.clc

test: test.clc opt.clc
	diff test.clc oktest.clc
	diff opt.clc okopt.clc

calcparse.c tokens.h: calcparse.y
	$(YACC) -d $<
	mv y.tab.c calcparse.c
	mv y.tab.h tokens.h

calclex.c: calclex.l
	$(LEX) $<
	mv lex.yy.c $*.c

realdistfiles: $(DISTFILES)

distfiles:
	@echo $(DISTFILES) | tr ' ' '\012'

distlist: $(DISTFILES)
	echo $(DISTFILES) | tr ' ' '\012' > dist.lst

gfiles: $(GENSRC) $(GENHDR)

depend: gfiles createdepend $(GENSRC) $(GENHDR)

createdepend: $(DEPENDFILE)
	$(CC) -MM $(DEPENDSRC) > $(DEPENDFILE)

$(DEPENDFILE):
	touch $(DEPENDFILE)

-include $(DEPENDFILE)

## Dependencies I know for sure
calc.o: calc.c calc.h
calclex.o: calclex.c calc.h tokens.h
calcparse.o: calcparse.c calc.h
