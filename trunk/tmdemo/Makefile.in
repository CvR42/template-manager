# A sample Tm project
# Author: C. van Reeuwijk.
#
# All rights reserved.
#
# To configure this Makefile, run 'configure'

MAKEFILE = Makefile
DEPENDFILE = $(MAKEFILE).d
CC = @CC@
LINKER = @CC@
LOCALLIB = @prefix@/lib
LOCALINCLUDE = @prefix@/include
LIBS = @LIBS@ $(LOCALLIB)/libtmc.a
YACC=@YACC@
LEX=@LEX@

# -I flags for  .h files
IPATH = -I$(LOCALINCLUDE)
PROGS = calcparse calcopt subst

# Files that are listed in the demonstration appendix of the reference
# manual.
REFMANFILES = calc.ct calc.ds calc.ht calcconf.t calclex.l \
    calcopt.c calcparse.y okopt.clc oktest.clc test.calc subst.ct oksubst.clc

# Where should REFMANFILES be copied to.
REFMANDIR = ../tmkrndoc

CFLAGS        = @CFLAGS@ $(IPATH) -DCACHESZ=0 -DVERSION=$(VERSION) -DSTAT
LDFLAGS	      = $(CFLAGS)

TM            = @TM@

DOC	      = README

DSFILES       = calc.ds

TMFILES       = subst.ct calc.ct calc.ht calcconf.t

TESTFILES     = test.calc oktest.clc okopt.clc oksubst.clc

HDRS	      =

MAKEFILE      = Makefile

# Source files that are not generated by any tool
NORMALSRC = 

GENSRC = calc.c calclex.c calcparse.c

GENHDR = calc.h tokens.h

DEPENDSRC = $(NORMALSRC) $(GENSRC)

OBJS = $(SRCS:.c=.o)

SRC = $(NORMALSRC) $(GENSRC)

TMOUTPUT = calc.c calc.h

GENFILES = $(GENSRC) $(GENHDR)

PARSESRC = calcparse.y calclex.l

PARSEGEN = calcparse.c calclex.c calc.c

PARSEOBJ = $(PARSEGEN:.c=.o)

OPTSRC = calcopt.c calc.c

OPTOBJ = $(OPTSRC:.c=.o)

SUBSTSRC = subst.c calc.c

SUBSTOBJ = $(SUBSTSRC:.c=.o)

JUNK          = sedlint y.output lint testerr testout index.sed \
		dsneed.t makelog testscr  log tags dist.lst \
		config.log version.h distlist $(GENSRC) $(GENHDR) \
		test.clc opt.clc $(OPTOBJ) $(PARSEOBJ) $(SUBSTOBJ)
MAKESTATES    = refman

# Files for configuration
CONFIGUREFILES = configure Makefile.in configure.in

DISTFILES = $(DSFILES) $(TMFILES) $(NORMALSRCS) $(HDRS) calcopt.c \
    $(TESTFILES) $(DOC) $(FOREIGNFILES) $(CONFIGUREFILES) $(PARSESRC)


help:
	@echo " Possible make targets:"
	@echo "all		Create local running programs."
	@echo "test		Run tests."
	@echo "install		Install relevant files."
	@echo "clean		Free disk space."
	@echo "distfiles	List distribution files."
	@echo "depend		Update dependencies in $(MAKEFILE)."
	@echo "refman		Copy files to the reference manual directory."

refman: $(REFMANFILES)
	cp $(REFMANFILES) $(REFMANDIR)
	touch refman

all: calcparse calcopt subst

calcparse: $(PARSEOBJ)
	$(LINKER) $(LDFLAGS) $(PARSEOBJ) $(LIBS) -o calcparse

calcopt: $(OPTOBJ)
	$(LINKER) $(LDFLAGS) $(OPTOBJ) $(LIBS) -o calcopt

subst: $(SUBSTOBJ)
	$(LINKER) $(LDFLAGS) $(SUBSTOBJ) $(LIBS) -o subst

install:
	@echo "Nothing to install"

distclean:
	rm -f $(OBJS) $(JUNK) $(PROGS)
	rm -f config.status config.cache config.h

empty:
	rm -f $(OBJS) $(JUNK) $(PROGS) $(MAKESTATES)
	rm -f config.status config.cache config.h

clean:
	rm -f $(OBJS) $(GENFILES) $(JUNK)

calc.h: calc.ht calc.ds calcconf.t
	$(TM) calc.ds calc.ht > calc.h

calc.c: calc.ct calc.ds calcconf.t
	$(TM) calc.ds calc.ct > calc.c

subst.c: subst.ct calc.ds
	$(TM) calc.ds subst.ct > subst.c

tags: $(SRCS) $(HDRS)
	ctags $(SRCS) $(HDRS)

test.clc: calcparse test.calc
	calcparse < test.calc > test.clc

opt.clc: test.clc
	calcopt < test.clc > opt.clc

subst.clc: test.clc
	subst < test.clc | calcopt > subst.clc

test: test.clc opt.clc subst.clc
	diff test.clc oktest.clc
	diff opt.clc okopt.clc
	diff subst.clc oksubst.clc

tests: test

check: test

calcparse.c tokens.h: calcparse.y
	$(YACC) -d $<
	mv y.tab.c calcparse.c
	mv y.tab.h tokens.h

calclex.c: calclex.l
	$(LEX) $<
	mv lex.yy.c $*.c

realdistfiles: $(DISTFILES)

distfiles:
	@echo $(DISTFILES) | tr ' ' '\012'

distlist: $(DISTFILES)
	echo $(DISTFILES) | tr ' ' '\012' > dist.lst

gfiles: $(GENSRC) $(GENHDR)

depend: gfiles createdepend $(GENSRC) $(GENHDR)

createdepend: $(DEPENDFILE)
	$(CC) -MM $(DEPENDSRC) > $(DEPENDFILE)

$(DEPENDFILE):
	touch $(DEPENDFILE)

-include $(DEPENDFILE)



# Configure-related rules.

configure: configure.in
	autoconf

config.status: configure
	./config.status --recheck

Makefile: Makefile.in config.status
	./config.status

JUNK += config.log config.cache
PRECIOUSJUNK += config.status configure

## Dependencies I know for sure
calc.o: calc.c calc.h
calclex.o: calclex.c calc.h tokens.h
calcparse.o: calcparse.c calc.h
